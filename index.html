<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YKS Dashboard OS</title>
    <!-- Chart.js Updated CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Varela+Round&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Frutiger Aero / Wii Palette - Default Blue */
            --hue: 200; /* Default Hue (Blue) */
            --bg-gradient: linear-gradient(135deg, hsl(var(--hue), 60%, 92%) 0%, hsl(var(--hue), 60%, 85%) 100%);
            --glass-bg: rgba(255, 255, 255, 0.85);
            --glass-border: rgba(255, 255, 255, 0.9);
            --card-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
            --glossy-gradient: linear-gradient(to bottom, #ffffff 0%, #f1f1f1 50%, #e1e1e1 51%, #f6f6f6 100%);
            --glossy-hover: linear-gradient(to bottom, #ffffff 0%, #f6f6f6 50%, #eaeaea 51%, #ffffff 100%);
            
            --primary-accent: hsl(var(--hue), 100%, 45%); /* Dynamic Color */
            --primary-light: hsl(var(--hue), 100%, 65%);
            
            --text-main: #2d3436;
            --text-secondary: #636e72;
            --input-bg: #ffffff;
            --radius-lg: 25px;
            --radius-md: 15px;
            --radius-pill: 50px;
            
            --font-family: 'Varela Round', sans-serif;
        }

        .dark-mode {
            --bg-gradient: linear-gradient(135deg, #1a1a1a 0%, #2d3436 100%);
            --glass-bg: rgba(45, 52, 54, 0.9);
            --glass-border: rgba(255, 255, 255, 0.1);
            --card-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.5);
            --glossy-gradient: linear-gradient(to bottom, #4a4a4a 0%, #3a3a3a 100%);
            --glossy-hover: linear-gradient(to bottom, #5a5a5a 0%, #4a4a4a 100%);
            
            /* Dark mode accent is slightly lighter for contrast */
            --primary-accent: hsl(var(--hue), 90%, 60%);
            
            --text-main: #dfe6e9;
            --text-secondary: #b2bec3;
            --input-bg: #2d3436;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: var(--font-family);
            background: var(--bg-gradient);
            background-attachment: fixed;
            color: var(--text-main);
            min-height: 100vh;
            overflow-x: hidden;
            padding-bottom: 120px; /* Space for dock */
            transition: background 0.5s ease, color 0.5s ease;
        }

        /* --- Header --- */
        .console-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 40px;
            position: relative;
            z-index: 100;
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 15px;
            background: var(--glass-bg);
            padding: 10px 20px;
            border-radius: var(--radius-pill);
            box-shadow: var(--card-shadow);
            border: 1px solid var(--glass-border);
            backdrop-filter: blur(8px);
        }

        .avatar-circle {
            width: 40px; height: 40px;
            background: var(--primary-accent);
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            color: white; font-weight: bold; font-size: 1.2rem;
            box-shadow: inset 0 -3px 5px rgba(0,0,0,0.2);
        }

        .system-time {
            font-size: 1.4rem; font-weight: bold;
            color: var(--text-main);
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .header-controls { display: flex; gap: 15px; }

        .control-btn {
            background: var(--glossy-gradient);
            width: 45px; height: 45px;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer;
            font-size: 1.2rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: transform 0.2s;
            color: #444; /* Icon color always dark on glossy btn */
        }
        .control-btn:active { transform: scale(0.9); }

        /* --- Grid Layout --- */
        .dashboard-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .tab-content { display: none; animation: fadeIn 0.4s ease; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .tile-grid {
            display: grid;
            grid-template-columns: 350px 1fr; /* Fixed left, fluid right */
            gap: 25px;
            margin-bottom: 30px;
        }

        @media (max-width: 1024px) {
            .tile-grid { grid-template-columns: 1fr; }
        }

        /* --- Cards --- */
        .console-card {
            background: var(--glass-bg);
            border-radius: var(--radius-lg);
            padding: 25px;
            box-shadow: var(--card-shadow);
            backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
            overflow: hidden;
            margin-bottom: 25px;
        }

        .console-card:hover {
            transform: translateY(-3px);
            border-color: var(--primary-accent);
        }

        .section-title {
            font-size: 1.3rem; margin-bottom: 15px;
            color: var(--primary-accent);
            display: flex; align-items: center; gap: 10px;
        }

        /* --- Inputs --- */
        .input-wrapper {
            background: rgba(0,0,0,0.05);
            border-radius: var(--radius-md);
            padding: 15px; margin-bottom: 15px;
        }
        .dark-mode .input-wrapper { background: rgba(255,255,255,0.05); }

        label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 0.9rem; color: var(--text-secondary); }

        input, select, textarea {
            width: 100%; padding: 10px 15px;
            border-radius: var(--radius-pill);
            border: 1px solid var(--glass-border);
            background: var(--input-bg);
            color: var(--text-main);
            font-family: var(--font-family);
            outline: none; transition: 0.3s;
        }
        input:focus, select:focus, textarea:focus {
            border-color: var(--primary-accent);
            box-shadow: 0 0 0 3px rgba(128, 128, 128, 0.1);
        }

        /* --- Buttons --- */
        .btn {
            padding: 10px 25px; border: none; border-radius: var(--radius-pill);
            font-weight: bold; cursor: pointer; transition: 0.2s;
            background: var(--glossy-gradient);
            box-shadow: 0 3px 0 rgba(0,0,0,0.1);
            color: #444; display: inline-flex; align-items: center; justify-content: center; gap: 5px;
        }
        .btn:hover { background: var(--glossy-hover); transform: translateY(-2px); }
        .btn:active { transform: translateY(2px); box-shadow: none; }

        .btn-primary {
            background: var(--primary-accent);
            color: white;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        .btn-primary:hover { filter: brightness(1.1); background: var(--primary-accent); color: white; }

        /* --- Upload --- */
        .upload-area {
            border: 2px dashed var(--primary-accent);
            border-radius: var(--radius-lg);
            padding: 30px; text-align: center;
            background: rgba(255,255,255,0.1); cursor: pointer;
            transition: 0.3s;
        }
        .upload-area:hover { background: rgba(255,255,255,0.3); }

        /* --- Stats Widgets --- */
        .stats-row {
            display: flex; gap: 15px; margin-bottom: 25px;
            overflow-x: auto; padding-bottom: 5px;
        }
        .stat-capsule {
            flex: 1; min-width: 120px;
            background: var(--glass-bg);
            padding: 15px; border-radius: 20px; text-align: center;
            box-shadow: var(--card-shadow);
            border: 1px solid var(--glass-border);
        }
        .stat-number { font-size: 1.8rem; font-weight: 800; color: var(--primary-accent); }
        .stat-label { font-size: 0.8rem; color: var(--text-secondary); }

        /* --- Gallery --- */
        .question-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 20px;
        }
        .question-card {
            background: var(--glass-bg);
            border-radius: 15px; overflow: hidden;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            transition: 0.3s; position: relative;
            cursor: pointer;
        }
        .question-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        .question-image { width: 100%; height: 160px; object-fit: cover; }
        .question-info { padding: 15px; }

        .tag-pill {
            padding: 3px 8px; border-radius: 10px; font-size: 0.7rem; font-weight: bold;
            display: inline-block; margin-right: 4px; margin-bottom: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        /* Tag Colors */
        .tag-sinav { background: #ff7675; color: white; }
        .tag-brans { background: var(--primary-light); color: white; }
        .tag-zorluk.zor { background: #d63031; color: white; }
        .tag-zorluk.orta { background: #fdcb6e; color: #d35400; }
        .tag-zorluk.kolay { background: #55efc4; color: #00b894; }
        .tag-durum.cozuldu { background: #00b894; color: white; }
        .tag-durum.yarim { background: #ffeaa7; color: #d35400; }
        .tag-durum.cozulmedi { background: #b2bec3; color: white; }

        .delete-btn {
            position: absolute; top: 8px; right: 8px;
            background: #ff4757; color: white;
            border: none; width: 28px; height: 28px; border-radius: 50%;
            cursor: pointer; opacity: 0; transition: 0.2s;
            font-weight: bold; z-index: 5;
            display: flex; align-items: center; justify-content: center;
        }
        .question-card:hover .delete-btn { opacity: 1; }

        /* --- Filters & Sorting --- */
        .gallery-tabs { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 10px; margin-bottom: 15px; }
        .gallery-tab {
            white-space: nowrap; padding: 6px 14px; border-radius: 20px;
            background: rgba(0,0,0,0.05); cursor: pointer; transition: 0.3s;
            font-size: 0.9rem; color: var(--text-secondary);
        }
        .dark-mode .gallery-tab { background: rgba(255,255,255,0.1); }
        .gallery-tab:hover { background: rgba(0,0,0,0.1); }
        .gallery-tab.active { background: var(--primary-accent); color: white; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }

        .sort-section { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .sort-btn {
            font-size: 0.85rem; padding: 6px 15px;
        }
        .sort-btn.active {
            background: var(--primary-accent);
            color: white;
            border: 1px solid transparent;
        }

        /* --- Dock --- */
        .dock-container {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.7); backdrop-filter: blur(20px);
            padding: 10px 25px; border-radius: 50px;
            display: flex; gap: 25px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            border: 1px solid rgba(255,255,255,0.5); z-index: 1000;
        }
        .dark-mode .dock-container { background: rgba(0, 0, 0, 0.6); border-color: rgba(255,255,255,0.1); }

        .dock-item {
            display: flex; flex-direction: column; align-items: center;
            text-decoration: none; color: var(--text-secondary);
            font-size: 0.8rem; transition: 0.3s;
        }
        .dock-icon {
            width: 45px; height: 45px;
            background: var(--glass-bg); border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.5rem; margin-bottom: 4px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            transition: 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .dock-item:hover .dock-icon, .dock-item.active .dock-icon {
            transform: translateY(-10px) scale(1.15);
            background: var(--primary-accent); color: white;
            box-shadow: 0 10px 20px rgba(0,0,0,0.3);
        }
        .dock-item.active { color: var(--primary-accent); font-weight: bold; }

        /* --- Modals --- */
        .modal {
            display: none; position: fixed; z-index: 2000; left: 0; top: 0;
            width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(5px);
            align-items: center; justify-content: center;
        }
        .modal-content {
            background: var(--glass-bg); border-radius: 20px;
            width: 90%; max-width: 900px; max-height: 90vh; overflow-y: auto;
            box-shadow: 0 25px 50px rgba(0,0,0,0.3);
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        
        .modal-header {
            background: var(--glossy-gradient); padding: 15px 25px;
            border-bottom: 1px solid rgba(0,0,0,0.1);
            display: flex; justify-content: space-between; align-items: center;
            border-radius: 20px 20px 0 0;
        }
        .modal-body { padding: 25px; display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        @media (max-width: 768px) { .modal-body { grid-template-columns: 1fr; } }

        /* Settings Modal Specific */
        .color-options { display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap; }
        .color-circle {
            width: 40px; height: 40px; border-radius: 50%; cursor: pointer;
            border: 3px solid transparent; transition: 0.2s;
        }
        .color-circle:hover { transform: scale(1.1); }
        .color-circle.active { border-color: var(--text-main); }

        /* Chart Wrapper */
        .chart-wrapper {
            height: 250px; position: relative;
            background: rgba(255,255,255,0.5);
            border-radius: 15px; padding: 10px;
        }
        .dark-mode .chart-wrapper { background: rgba(0,0,0,0.2); }

        /* Helpers */
        #fileInput, #importFile { display: none; }
        .test-input-grid { display: grid; grid-template-columns: 80px 1fr auto; gap: 8px; align-items: center; margin-bottom: 10px; }
        .input-group { display: flex; gap: 5px; }
        .count-input { text-align: center; }
        .test-list-item { 
            background: var(--glass-bg); padding: 15px; margin-bottom: 10px; border-radius: 12px;
            display: flex; justify-content: space-between; align-items: center; cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        
    </style>
</head>
<body>

    <!-- Header -->
    <div class="console-header">
        <div class="user-profile">
            <div class="avatar-circle">YG</div>
            <span style="font-weight:bold;">YKS OS</span>
        </div>
        <div class="system-time" id="clock">12:00</div>
        <div class="header-controls">
            <div class="control-btn" id="darkModeToggle" title="Tema">üåô</div>
            <div class="control-btn" id="settingsBtn" title="Ayarlar">‚öôÔ∏è</div>
        </div>
    </div>

    <div class="dashboard-container">
        
        <!-- PAGE 1: SORU DEFTERƒ∞ -->
        <div id="questionPage" class="tab-content active">
            
            <!-- √úst ƒ∞statistikler -->
            <div class="stats-row">
                <div class="stat-capsule"><div class="stat-number" id="totalQuestions">0</div><div class="stat-label">Toplam Soru</div></div>
                <div class="stat-capsule"><div class="stat-number" id="solvedQuestions">0</div><div class="stat-label">√á√∂z√ºlen</div></div>
                <div class="stat-capsule"><div class="stat-number" id="streakCounter">0</div><div class="stat-label">G√ºnl√ºk Seri üî•</div></div>
                <div class="stat-capsule"><div class="stat-number" id="hardQuestions">0</div><div class="stat-label">Zor Sorular</div></div>
            </div>

            <div class="tile-grid">
                
                <!-- SOL KOLON: ƒ∞≈ülemler & Analiz -->
                <div class="left-column">
                    <!-- Soru Ekle -->
                    <div class="console-card">
                        <h2 class="section-title">‚ûï Soru Ekle</h2>
                        <div class="upload-area" id="uploadArea">
                            <div style="font-size: 2rem;">üì∑</div>
                            <p style="margin:5px 0;">G√∂rseli bƒ±rak veya se√ß</p>
                        </div>
                        <input type="file" id="fileInput" accept="image/*" multiple>
                        
                        <div class="input-wrapper" style="margin-top: 15px;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom:10px;">
                                <select id="sinavOturumu"><option value="TYT">TYT</option><option value="AYT">AYT</option></select>
                                <select id="brans">
                                    <option value="Matematik">Matematik</option>
                                    <option value="Fizik">Fizik</option>
                                    <option value="Kimya">Kimya</option>
                                    <option value="Biyoloji">Biyoloji</option>
                                    <option value="T√ºrk√ße">T√ºrk√ße</option>
                                    <option value="Tarih">Tarih</option>
                                    <option value="Coƒürafya">Coƒürafya</option>
                                    <option value="Geometri">Geometri</option>
                                    <option value="Edebiyat">Edebiyat</option>
                                    <option value="Felsefe">Felsefe</option>
                                </select>
                            </div>
                            <input type="text" id="konu" placeholder="Konu (√ñrn: Limit)" style="margin-bottom:10px;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom:10px;">
                                <select id="durum">
                                    <option value="cozulmedi">‚ùå √á√∂z√ºlmedi</option>
                                    <option value="yarim">‚ö†Ô∏è Yarƒ±m</option>
                                    <option value="cozuldu">‚úÖ √á√∂z√ºld√º</option>
                                </select>
                                <select id="zorluk">
                                    <option value="kolay">üü¢ Kolay</option>
                                    <option value="orta">üü° Orta</option>
                                    <option value="zor">üî¥ Zor</option>
                                </select>
                            </div>
                            <textarea id="yorum" rows="2" placeholder="Notlarƒ±n..."></textarea>
                            <input type="text" id="kaynak" placeholder="Kaynak" style="margin-top:10px;">
                        </div>
                        <button class="btn btn-primary" id="btnSaveQuestions" style="width: 100%;">Kaydet</button>
                    </div>

                    <!-- Analiz Grafikleri (SOLA TA≈ûINDI) -->
                    <div class="console-card">
                        <h2 class="section-title">üìä Analiz</h2>
                        <div style="margin-bottom: 20px;">
                            <h4 style="margin-bottom:10px; font-size:0.9rem; color:var(--text-secondary);">Bran≈ü Daƒüƒ±lƒ±mƒ±</h4>
                            <div class="chart-wrapper">
                                <canvas id="bransChart"></canvas>
                            </div>
                        </div>
                        <div>
                            <h4 style="margin-bottom:10px; font-size:0.9rem; color:var(--text-secondary);">Zorluk Daƒüƒ±lƒ±mƒ±</h4>
                            <div class="chart-wrapper">
                                <canvas id="zorlukChart"></canvas>
                            </div>
                        </div>
                    </div>

                     <!-- En √áok Hata Yapƒ±lanlar -->
                     <div class="console-card">
                        <h2 class="section-title">üéØ Odak</h2>
                        <ul id="topSubjectsList" style="list-style: none; padding:0; font-size:0.9rem;">
                            <li style="color:var(--text-secondary); text-align:center;">Veri yok</li>
                        </ul>
                    </div>
                </div>

                <!-- SAƒû KOLON: Galeri -->
                <div class="right-column">
                    <div class="console-card" style="min-height: 80vh;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap:wrap; gap:10px;">
                            <h2 class="section-title">üìñ Soru K√ºt√ºphanesi</h2>
                            <div style="display: flex; align-items: center; gap: 5px;">
                                <input type="number" id="weeklyGoalInput" placeholder="Hedef" style="width: 70px;">
                                <button class="btn" id="btnSetGoal" style="padding: 8px;">üéØ</button>
                                <span id="weeklyGoalStatus" style="font-size: 0.8rem; margin-left:5px; font-weight:bold;"></span>
                            </div>
                        </div>

                        <!-- Filtre Sekmeleri -->
                        <div class="gallery-tabs" id="galleryTabs">
                            <span class="gallery-tab active" data-brans="">T√ºm√º</span>
                            <span class="gallery-tab" data-brans="Matematik">Matematik</span>
                            <span class="gallery-tab" data-brans="Geometri">Geometri</span>
                            <span class="gallery-tab" data-brans="Fizik">Fizik</span>
                            <span class="gallery-tab" data-brans="Kimya">Kimya</span>
                            <span class="gallery-tab" data-brans="Biyoloji">Biyoloji</span>
                            <span class="gallery-tab" data-brans="T√ºrk√ße">T√ºrk√ße</span>
                            <span class="gallery-tab" data-brans="Edebiyat">Edebiyat</span>
                            <span class="gallery-tab" data-brans="Tarih">Tarih</span>
                            <span class="gallery-tab" data-brans="Coƒürafya">Coƒürafya</span>
                        </div>
                        
                        <!-- Sƒ±ralama Butonlarƒ± -->
                        <div class="sort-section">
                            <button class="btn sort-btn" id="btnFilterExam" data-state="all">Oturum: Hepsi</button>
                            <button class="btn sort-btn active" id="btnSortDate">üóìÔ∏è Tarih (Y-E)</button>
                            <button class="btn sort-btn" id="btnSortDifficulty">üìä Zorluk</button>
                        </div>

                        <div class="question-grid" id="questionGrid">
                            <div class="empty-state" style="grid-column: 1/-1; text-align: center; color: var(--text-secondary); padding: 40px;">
                                <div style="font-size: 3rem; opacity: 0.5;">üì≠</div>
                                <p>Hen√ºz soru eklenmedi.</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Veri Y√∂netimi -->
                    <div class="console-card">
                        <h2 class="section-title">üì¶ Yedekleme</h2>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn" id="btnExport" style="flex:1;">üì§ Yedek ƒ∞ndir</button>
                            <button class="btn" id="btnImport" style="flex:1;">üì• Yedek Y√ºkle</button>
                        </div>
                        <input type="file" id="importFile" accept=".json">
                    </div>
                </div>
            </div>
        </div>

        <!-- PAGE 2: DENEME TAKƒ∞P -->
        <div id="testPage" class="tab-content">
            <div class="tile-grid">
                <div class="console-card">
                    <h2 class="section-title">üìù Deneme Giri≈üi</h2>
                    <div class="input-wrapper">
                        <div style="display: flex; gap: 10px;">
                            <select id="testType" style="flex:1;"><option value="TYT">TYT</option><option value="AYT">AYT</option></select>
                            <input type="text" id="testName" placeholder="√ñrn: 3D Yayƒ±nlarƒ± Deneme 1" style="flex:3;">
                        </div>
                    </div>

                    <!-- Soru Sayƒ±larƒ± -->
                    <div style="background: rgba(0,0,0,0.02); padding: 10px; border-radius: 10px; margin-bottom: 15px;">
                        <h4 style="margin-bottom: 5px; color: var(--text-secondary); font-size:0.8rem;">Soru Sayƒ±larƒ± (Toplam)</h4>
                        <div id="tytTotalQuestions" style="display: flex; gap: 5px; flex-wrap: wrap;">
                            <input type="number" id="tytMatToplam" value="40" class="total-q-input" data-lesson="tytMat" style="width: 50px;" title="Matematik">
                            <input type="number" id="tytTurkceToplam" value="40" class="total-q-input" data-lesson="tytTurkce" style="width: 50px;" title="T√ºrk√ße">
                            <input type="number" id="tytSosyalToplam" value="20" class="total-q-input" data-lesson="tytSosyal" style="width: 50px;" title="Sosyal">
                            <input type="number" id="tytFenToplam" value="20" class="total-q-input" data-lesson="tytFen" style="width: 50px;" title="Fen">
                        </div>
                        <div id="aytTotalQuestions" style="display: none; gap: 5px; flex-wrap: wrap;">
                             <input type="number" id="aytMatToplam" value="40" class="total-q-input" data-lesson="aytMat" style="width: 50px;">
                             <input type="number" id="aytFizikToplam" value="14" class="total-q-input" data-lesson="aytFizik" style="width: 50px;">
                             <input type="number" id="aytKimyaToplam" value="13" class="total-q-input" data-lesson="aytKimya" style="width: 50px;">
                             <input type="number" id="aytBiyolojiToplam" value="13" class="total-q-input" data-lesson="aytBiyoloji" style="width: 50px;">
                             <input type="number" id="aytEdebiyatToplam" value="24" class="total-q-input" data-lesson="aytEdebiyat" style="width: 50px;">
                             <input type="number" id="aytCografyaToplam" value="6" class="total-q-input" data-lesson="aytCografya" style="width: 50px;">
                        </div>
                    </div>

                    <div id="tytTestInputs">
                        <div class="test-input-grid"><label>Mat</label><div class="input-group"><input type="number" data-lesson="tytMat" class="dogru-input count-input" placeholder="D"><input type="number" data-lesson="tytMat" class="yanlis-input count-input" placeholder="Y"><input type="number" data-lesson="tytMat" class="bos-display" placeholder="B" disabled></div><button class="btn btn-primary btn-add-subject" data-lesson="tytMat" style="padding: 5px 10px; font-size: 0.7rem;">Konu</button></div>
                        <div class="test-input-grid"><label>Tr</label><div class="input-group"><input type="number" data-lesson="tytTurkce" class="dogru-input count-input" placeholder="D"><input type="number" data-lesson="tytTurkce" class="yanlis-input count-input" placeholder="Y"><input type="number" data-lesson="tytTurkce" class="bos-display" placeholder="B" disabled></div><button class="btn btn-primary btn-add-subject" data-lesson="tytTurkce" style="padding: 5px 10px; font-size: 0.7rem;">Konu</button></div>
                        <div class="test-input-grid"><label>Sos</label><div class="input-group"><input type="number" data-lesson="tytSosyal" class="dogru-input count-input" placeholder="D"><input type="number" data-lesson="tytSosyal" class="yanlis-input count-input" placeholder="Y"><input type="number" data-lesson="tytSosyal" class="bos-display" placeholder="B" disabled></div><button class="btn btn-primary btn-add-subject" data-lesson="tytSosyal" style="padding: 5px 10px; font-size: 0.7rem;">Konu</button></div>
                        <div class="test-input-grid"><label>Fen</label><div class="input-group"><input type="number" data-lesson="tytFen" class="dogru-input count-input" placeholder="D"><input type="number" data-lesson="tytFen" class="yanlis-input count-input" placeholder="Y"><input type="number" data-lesson="tytFen" class="bos-display" placeholder="B" disabled></div><button class="btn btn-primary btn-add-subject" data-lesson="tytFen" style="padding: 5px 10px; font-size: 0.7rem;">Konu</button></div>
                    </div>

                    <div id="aytTestInputs" style="display: none;">
                         <div class="test-input-grid"><label>Mat</label><div class="input-group"><input type="number" data-lesson="aytMat" class="dogru-input count-input"><input type="number" data-lesson="aytMat" class="yanlis-input count-input"><input type="number" data-lesson="aytMat" class="bos-display" disabled></div><button class="btn btn-primary btn-add-subject" data-lesson="aytMat" style="font-size:0.7rem;">Konu</button></div>
                         <div class="test-input-grid"><label>Fiz</label><div class="input-group"><input type="number" data-lesson="aytFizik" class="dogru-input count-input"><input type="number" data-lesson="aytFizik" class="yanlis-input count-input"><input type="number" data-lesson="aytFizik" class="bos-display" disabled></div><button class="btn btn-primary btn-add-subject" data-lesson="aytFizik" style="font-size:0.7rem;">Konu</button></div>
                         <div class="test-input-grid"><label>Kim</label><div class="input-group"><input type="number" data-lesson="aytKimya" class="dogru-input count-input"><input type="number" data-lesson="aytKimya" class="yanlis-input count-input"><input type="number" data-lesson="aytKimya" class="bos-display" disabled></div><button class="btn btn-primary btn-add-subject" data-lesson="aytKimya" style="font-size:0.7rem;">Konu</button></div>
                         <div class="test-input-grid"><label>Biyo</label><div class="input-group"><input type="number" data-lesson="aytBiyoloji" class="dogru-input count-input"><input type="number" data-lesson="aytBiyoloji" class="yanlis-input count-input"><input type="number" data-lesson="aytBiyoloji" class="bos-display" disabled></div><button class="btn btn-primary btn-add-subject" data-lesson="aytBiyoloji" style="font-size:0.7rem;">Konu</button></div>
                         <div class="test-input-grid"><label>Edb</label><div class="input-group"><input type="number" data-lesson="aytEdebiyat" class="dogru-input count-input"><input type="number" data-lesson="aytEdebiyat" class="yanlis-input count-input"><input type="number" data-lesson="aytEdebiyat" class="bos-display" disabled></div><button class="btn btn-primary btn-add-subject" data-lesson="aytEdebiyat" style="font-size:0.7rem;">Konu</button></div>
                         <div class="test-input-grid"><label>Cog</label><div class="input-group"><input type="number" data-lesson="aytCografya" class="dogru-input count-input"><input type="number" data-lesson="aytCografya" class="yanlis-input count-input"><input type="number" data-lesson="aytCografya" class="bos-display" disabled></div><button class="btn btn-primary btn-add-subject" data-lesson="aytCografya" style="font-size:0.7rem;">Konu</button></div>
                    </div>

                    <button class="btn btn-primary" id="btnSaveTestResult" style="width: 100%; margin-top: 20px;">üíæ Sonucu Kaydet</button>
                </div>

                <div class="right-column">
                    <div class="console-card">
                         <h2 class="section-title">üìä ƒ∞statistikler</h2>
                         <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div class="stat-capsule"><div class="stat-number" id="tytAverageNet">0</div><div class="stat-label">TYT Ort.</div></div>
                            <div class="stat-capsule"><div class="stat-number" id="tytBestNet">0</div><div class="stat-label">TYT En ƒ∞yi</div></div>
                            <div class="stat-capsule"><div class="stat-number" id="aytAverageNet">0</div><div class="stat-label">AYT Ort.</div></div>
                            <div class="stat-capsule"><div class="stat-number" id="aytBestNet">0</div><div class="stat-label">AYT En ƒ∞yi</div></div>
                         </div>
                    </div>
                    
                    <div class="console-card">
                        <h2 class="section-title">üìú Son Denemeler</h2>
                        <div id="testListContainer" style="max-height: 400px; overflow-y: auto;"></div>
                    </div>
                    
                    <div class="console-card">
                         <h2 class="section-title">üìà Geli≈üim Grafiƒüi</h2>
                         <div class="chart-wrapper">
                             <canvas id="tytTotalChart"></canvas>
                         </div>
                         <div class="chart-wrapper" style="margin-top: 15px;">
                             <canvas id="aytTotalChart"></canvas>
                         </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- DOCK MENU -->
    <div class="dock-container" id="navMenu">
        <a href="#" class="dock-item active" data-page="questionPage">
            <div class="dock-icon">üìö</div>
            <span>Soru Defteri</span>
        </a>
        <a href="#" class="dock-item" data-page="testPage">
            <div class="dock-icon">üìà</div>
            <span>Deneme Takip</span>
        </a>
    </div>

    <!-- MODAL: Soru Detay -->
    <div id="myModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Soru Detayƒ±</h2>
                <span class="close" id="modalCloseBtn" style="cursor:pointer; font-size:1.5rem;">&times;</span>
            </div>
            <div class="modal-body">
                <div>
                    <img id="modalImage" src="" style="width:100%; border-radius:10px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); cursor: zoom-in;">
                </div>
                <div>
                    <p id="modalDate" style="color:var(--text-secondary); margin-bottom:10px; font-size:0.9rem;"></p>
                    <div id="modalTags" style="margin-bottom:15px;"></div>
                    <div class="input-wrapper">
                        <label>Kaynak</label>
                        <div id="modalSource" style="font-weight:bold;"></div>
                    </div>
                    <div class="input-wrapper">
                        <label>Notlar</label>
                        <div id="modalComment"></div>
                    </div>
                    
                    <div class="input-wrapper" style="margin-top: 20px;">
                        <label>√á√∂z√ºm G√∂rseli</label>
                        <img id="solutionImage" src="" style="width:100%; border-radius:10px; margin-bottom:10px;">
                        <p id="noSolutionText" style="color:var(--text-secondary); font-style:italic;">√á√∂z√ºm Yok</p>
                        <input type="file" id="solutionInput" style="margin-top:10px;">
                        <button class="btn btn-primary" id="btnSaveSolution" style="margin-top:10px; width:100%;">√á√∂z√ºm√º Kaydet</button>
                    </div>

                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <select id="modalDurumSelect" style="flex:1;">
                            <option value="cozulmedi">√á√∂z√ºlmedi</option>
                            <option value="yarim">Yarƒ±m</option>
                            <option value="cozuldu">√á√∂z√ºld√º</option>
                        </select>
                        <button class="btn btn-primary" id="btnUpdateStatus">G√ºncelle</button>
                    </div>
                    <button class="btn" id="btnDeleteQuestion" style="width:100%; margin-top:10px; background: #ff4757; color: white;">Sil</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL: Ayarlar (Renk Temasƒ±) -->
    <div id="settingsModal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h2>‚öôÔ∏è Ayarlar</h2>
                <span class="close" id="settingsCloseBtn" style="cursor:pointer; font-size:1.5rem;">&times;</span>
            </div>
            <div style="padding: 25px;">
                <label>Tema Rengi</label>
                <div class="color-options">
                    <div class="color-circle" style="background: hsl(200, 100%, 45%);" data-hue="200"></div> <!-- Mavi -->
                    <div class="color-circle" style="background: hsl(260, 100%, 60%);" data-hue="260"></div> <!-- Mor -->
                    <div class="color-circle" style="background: hsl(150, 100%, 40%);" data-hue="150"></div> <!-- Ye≈üil -->
                    <div class="color-circle" style="background: hsl(30, 100%, 50%);" data-hue="30"></div>  <!-- Turuncu -->
                    <div class="color-circle" style="background: hsl(340, 100%, 55%);" data-hue="340"></div> <!-- Pembe -->
                    <div class="color-circle" style="background: hsl(0, 0%, 40%);" data-hue="0"></div>   <!-- Siyah/Gri -->
                </div>
                
                <button class="btn" id="btnResetTheme" style="width:100%; margin-top:20px;">Varsayƒ±lana D√∂n</button>
            </div>
        </div>
    </div>

    <!-- MODAL: Fullscreen -->
    <div id="fullscreenModal" class="modal">
        <span id="fullscreenCloseBtn" style="position:absolute; top:20px; right:30px; color:white; font-size:3rem; cursor:pointer;">&times;</span>
        <img id="fullscreenModalContent" style="max-height:95%; max-width:95%;">
    </div>

    <!-- MODAL: Konu Ekle -->
    <div id="subjectModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2 id="subjectModalTitle">Konu Ekle</h2>
                <span class="close" id="subjectModalCloseBtn" style="cursor:pointer;">&times;</span>
            </div>
            <div style="padding: 20px;">
                <p id="subjectModalInfo" style="margin-bottom: 15px; color: var(--text-secondary);">Bu derste <strong id="mistakeCount">0</strong> hata i√ßin konu giriniz.</p>
                <input type="text" id="subjectInput" placeholder="Konu adƒ± yazƒ±p Enter'a bas">
                <div id="subjectTagsContainer" style="margin-top:15px; display:flex; flex-wrap:wrap; gap:5px;"></div>
                <button id="saveSubjectsBtn" class="btn btn-primary" style="margin-top:20px; width:100%;">Tamam</button>
            </div>
        </div>
    </div>

    <!-- MODAL: Deneme Detay -->
    <div id="testDetailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="testDetailModalTitle">Deneme Detayƒ±</h2>
                <span class="close" id="testDetailModalCloseBtn" style="cursor:pointer;">&times;</span>
            </div>
            <div class="modal-body" id="testDetailModalBody" style="display:block;"></div>
        </div>
    </div>

    <script>
        // --- Clock ---
        setInterval(() => {
            const now = new Date();
            const h = String(now.getHours()).padStart(2, '0');
            const m = String(now.getMinutes()).padStart(2, '0');
            document.getElementById('clock').innerText = `${h}:${m}`;
        }, 1000);

        // --- IndexedDB ---
        let db;
        const DB_NAME = 'YKSDefteriDB';
        const DB_VERSION = 1;
        const QUESTION_STORE = 'questions';
        const TEST_STORE = 'tests';

        function initDB() {
            return new Promise((resolve, reject) => {
                const req = indexedDB.open(DB_NAME, DB_VERSION);
                req.onupgradeneeded = (e) => {
                    const db = e.target.result;
                    if (!db.objectStoreNames.contains(QUESTION_STORE)) db.createObjectStore(QUESTION_STORE, { keyPath: 'id' });
                    if (!db.objectStoreNames.contains(TEST_STORE)) db.createObjectStore(TEST_STORE, { keyPath: 'id' });
                };
                req.onsuccess = (e) => { db = e.target.result; resolve(db); };
                req.onerror = (e) => reject(e.target.error);
            });
        }

        function getStore(name, mode) { return db.transaction(name, mode).objectStore(name); }
        function addToDB(name, item) { return new Promise((res, rej) => { const r = getStore(name, 'readwrite').add(item); r.onsuccess = () => res(); r.onerror = (e) => rej(e.target.error); }); }
        function updateInDB(name, item) { return new Promise((res, rej) => { const r = getStore(name, 'readwrite').put(item); r.onsuccess = () => res(); r.onerror = (e) => rej(e.target.error); }); }
        function deleteFromDB(name, id) { return new Promise((res, rej) => { const r = getStore(name, 'readwrite').delete(id); r.onsuccess = () => res(); r.onerror = (e) => rej(e.target.error); }); }
        function getAllFromDB(name) { return new Promise((res, rej) => { const r = getStore(name, 'readonly').getAll(); r.onsuccess = (e) => res(e.target.result); r.onerror = (e) => rej(e.target.error); }); }

        // --- State ---
        let questions = [], tests = [], currentQuestionId = null, tempMistakeSubjects = {};
        
        // Sorting State
        let currentSortType = 'date'; // 'date' | 'difficulty'
        let dateSortDirection = 'desc'; 
        let difficultySortDirection = 'desc';
        let filterExamState = 'all'; // 'all' | 'TYT' | 'AYT'

        async function loadData() {
            try {
                const [qData, tData] = await Promise.all([getAllFromDB(QUESTION_STORE), getAllFromDB(TEST_STORE)]);
                questions = qData; tests = tData;
                updateUI(); checkDailyStreak(); updateWeeklyGoalStatus();
            } catch (e) { console.error(e); }
        }

        function updateUI() {
            updateQuestionGrid(); updateStats(); drawCharts(); updateTestUI(); updateTopMistakeSubjects();
        }

        // --- Questions ---
        async function saveQuestions() {
            const fileInput = document.getElementById('fileInput');
            if (fileInput.files.length === 0) { alert('L√ºtfen g√∂rsel se√ßin.'); return; }
            
            for (const image of fileInput.files) {
                const reader = new FileReader();
                reader.onload = async function(e) {
                    const newQ = {
                        id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
                        image: e.target.result,
                        sinav: document.getElementById('sinavOturumu').value,
                        brans: document.getElementById('brans').value,
                        konu: document.getElementById('konu').value,
                        durum: document.getElementById('durum').value,
                        zorluk: document.getElementById('zorluk').value,
                        yorum: document.getElementById('yorum').value,
                        kaynak: document.getElementById('kaynak').value,
                        date: new Date().toISOString(),
                        solution: null
                    };
                    await addToDB(QUESTION_STORE, newQ);
                    questions.push(newQ);
                    updateUI();
                    checkDailyStreak(true); updateWeeklyGoalStatus();
                };
                reader.readAsDataURL(image);
            }
            // Reset Fields
            document.getElementById('konu').value = ''; 
            document.getElementById('yorum').value = '';
            fileInput.value = '';
        }

        function updateQuestionGrid() {
            const grid = document.getElementById('questionGrid');
            grid.innerHTML = '';
            
            const activeTab = document.querySelector('.gallery-tab.active');
            const filterBrans = activeTab ? activeTab.dataset.brans : '';
            
            let filtered = questions.filter(q => 
                (!filterBrans || q.brans === filterBrans) && 
                (filterExamState === 'all' || q.sinav === filterExamState)
            );

            const diffOrder = { 'zor': 3, 'orta': 2, 'kolay': 1 };
            
            filtered.sort((a, b) => {
                if (currentSortType === 'date') {
                    return dateSortDirection === 'desc' 
                        ? new Date(b.date) - new Date(a.date) 
                        : new Date(a.date) - new Date(b.date);
                } else {
                    const dA = diffOrder[a.zorluk] || 0;
                    const dB = diffOrder[b.zorluk] || 0;
                    return difficultySortDirection === 'desc' ? dB - dA : dA - dB;
                }
            });

            if (filtered.length === 0) {
                grid.innerHTML = `<div class="empty-state" style="grid-column: 1/-1; text-align: center; color: var(--text-secondary); padding: 40px;"><div style="font-size: 3rem; opacity: 0.5;">üì≠</div><p>Soru bulunamadƒ±.</p></div>`;
                return;
            }

            filtered.forEach(q => {
                const card = document.createElement('div');
                card.className = 'question-card';
                card.dataset.questionId = q.id;
                card.innerHTML = `
                    <button class="delete-btn" data-question-id="${q.id}">&times;</button>
                    <img src="${q.image}" class="question-image">
                    <div class="question-info">
                        <div style="margin-bottom:5px;">
                            <span class="tag-pill tag-brans">${q.brans}</span>
                            <span class="tag-pill tag-zorluk ${q.zorluk}">${q.zorluk}</span>
                            <span class="tag-pill tag-durum ${q.durum}">${q.durum === 'cozulmedi' ? 'X' : (q.durum === 'yarim' ? '!' : 'OK')}</span>
                        </div>
                        <div style="font-size:0.9rem; font-weight:bold; color:var(--text-main); white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${q.konu || 'Konu Yok'}</div>
                        <div style="font-size:0.75rem; color:var(--text-secondary); margin-top:2px;">${new Date(q.date).toLocaleDateString()}</div>
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        // --- Tests ---
        async function saveTestResult() {
            const testType = document.getElementById('testType').value;
            const testName = document.getElementById('testName').value;
            if (!testName) { alert('Deneme adƒ± giriniz.'); return; }

            let result = {
                id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
                date: new Date().toISOString().split('T')[0],
                type: testType, name: testName, results: {}
            };

            const sections = testType === 'TYT' ? ['tytMat', 'tytTurkce', 'tytSosyal', 'tytFen'] : ['aytMat', 'aytFizik', 'aytKimya', 'aytBiyoloji', 'aytEdebiyat', 'aytCografya'];
            let totalNet = 0;

            for (const sec of sections) {
                const total = parseInt(document.getElementById(`${sec}Toplam`).value) || 0;
                const d = parseInt(document.querySelector(`.dogru-input[data-lesson='${sec}']`).value) || 0;
                const y = parseInt(document.querySelector(`.yanlis-input[data-lesson='${sec}']`).value) || 0;
                
                if (d + y > total) { alert('Hatalƒ± soru sayƒ±sƒ±!'); return; }
                const net = d - (y / 4);
                result.results[sec] = { dogru: d, yanlis: y, bos: total - d - y, net: net, mistakeSubjects: tempMistakeSubjects[sec] || [] };
                totalNet += net;
            }
            result.totalNet = totalNet;
            await addToDB(TEST_STORE, result);
            tests.push(result);
            updateTestUI();
            tempMistakeSubjects = {};
            document.querySelectorAll('.count-input').forEach(i => i.value = '');
            document.getElementById('testName').value = '';
        }

        function updateTestUI() {
            const cont = document.getElementById('testListContainer');
            cont.innerHTML = '';
            tests.sort((a,b) => new Date(b.date) - new Date(a.date)).forEach(t => {
                const div = document.createElement('div');
                div.className = 'test-list-item';
                div.dataset.testid = t.id;
                div.innerHTML = `
                    <div><strong>${t.name}</strong> <small style="color:var(--text-secondary);">(${t.type})</small></div>
                    <div style="font-weight:bold; color:var(--primary-accent); display:flex; align-items:center; gap:10px;">
                        ${t.totalNet.toFixed(2)} Net 
                        <span class="test-delete-btn" data-testid="${t.id}" style="color:#ff4757; font-size:1.2rem;">&times;</span>
                    </div>`;
                cont.appendChild(div);
            });
            drawTestCharts(); updateTestStats();
        }

        // --- Charts ---
        function getChartTextColor() {
            return document.body.classList.contains('dark-mode') ? '#dfe6e9' : '#2d3436';
        }

        function drawCharts() {
            const bransData = {}, zorlukData = {};
            questions.forEach(q => {
                bransData[q.brans] = (bransData[q.brans] || 0) + 1;
                zorlukData[q.zorluk] = (zorlukData[q.zorluk] || 0) + 1;
            });
            
            const commonOpts = { 
                responsive: true, maintainAspectRatio: false, 
                plugins: { legend: { labels: { color: getChartTextColor() }, position: 'bottom' } } 
            };

            const config = (id, type, labels, data, colors) => {
                const ctx = document.getElementById(id).getContext('2d');
                if(window[id] instanceof Chart) window[id].destroy();
                window[id] = new Chart(ctx, {
                    type: type,
                    data: { labels: labels, datasets: [{ data: data, backgroundColor: colors, borderWidth: 0 }] },
                    options: commonOpts
                });
            };
            
            // Generate distinct colors based on hue
            const accent = getComputedStyle(document.documentElement).getPropertyValue('--primary-accent').trim();
            const colors = [accent, '#55efc4', '#fab1a0', '#ffeaa7', '#a29bfe', '#fd79a8', '#636e72'];
            
            config('bransChart', 'doughnut', Object.keys(bransData), Object.values(bransData), colors);
            config('zorlukChart', 'pie', Object.keys(zorlukData), Object.values(zorlukData), ['#55efc4', '#fdcb6e', '#ff7675']);
        }

        function drawTestCharts() {
            const tyt = tests.filter(t => t.type === 'TYT').sort((a, b) => new Date(a.date) - new Date(b.date));
            const ayt = tests.filter(t => t.type === 'AYT').sort((a, b) => new Date(a.date) - new Date(b.date));
            
            const textColor = getChartTextColor();
            const accent = getComputedStyle(document.documentElement).getPropertyValue('--primary-accent').trim();

            const lineConfig = (id, label, data, labels, color) => {
                const ctx = document.getElementById(id).getContext('2d');
                if(window[id] instanceof Chart) window[id].destroy();
                window[id] = new Chart(ctx, {
                    type: 'line',
                    data: { labels: labels, datasets: [{ label: label, data: data, borderColor: color, tension: 0.4, fill: true, backgroundColor: color + '20' }] },
                    options: { 
                        responsive: true, maintainAspectRatio: false,
                        scales: { 
                            y: { ticks: { color: textColor }, grid: { color: textColor + '20' } },
                            x: { ticks: { color: textColor }, grid: { display: false } }
                        },
                        plugins: { legend: { labels: { color: textColor } } }
                    }
                });
            };
            
            lineConfig('tytTotalChart', 'TYT Net', tyt.map(t=>t.totalNet), tyt.map(t=>t.name), accent);
            lineConfig('aytTotalChart', 'AYT Net', ayt.map(t=>t.totalNet), ayt.map(t=>t.name), '#a29bfe');
        }

        // --- Logic ---
        function updateStats() {
            document.getElementById('totalQuestions').innerText = questions.length;
            document.getElementById('solvedQuestions').innerText = questions.filter(q => q.durum === 'cozuldu').length;
            document.getElementById('hardQuestions').innerText = questions.filter(q => q.zorluk === 'zor').length;
        }

        function checkDailyStreak(increment = false) {
            const today = new Date().toISOString().split('T')[0];
            let streak = parseInt(localStorage.getItem('streak') || 0);
            const last = localStorage.getItem('lastActiveDay');
            if (increment && last !== today) {
                const yest = new Date(); yest.setDate(yest.getDate()-1);
                streak = (last === yest.toISOString().split('T')[0]) ? streak + 1 : 1;
                localStorage.setItem('lastActiveDay', today); localStorage.setItem('streak', streak);
            }
            document.getElementById('streakCounter').innerText = streak;
        }

        function updateWeeklyGoalStatus() {
            const goal = parseInt(localStorage.getItem('weeklyQuestionGoal') || 0);
            const start = new Date(); start.setDate(start.getDate() - (start.getDay() + 6) % 7); start.setHours(0,0,0,0);
            const count = questions.filter(q => new Date(q.date) >= start).length;
            document.getElementById('weeklyGoalStatus').innerText = goal > 0 ? `${count}/${goal}` : '';
        }

        function updateTopMistakeSubjects() {
            const list = document.getElementById('topSubjectsList'); list.innerHTML = '';
            const counts = {};
            questions.forEach(q => { if(q.konu) counts[q.konu] = (counts[q.konu]||0)+1; });
            const sorted = Object.entries(counts).sort(([,a],[,b])=>b-a).slice(0,5);
            if(sorted.length === 0) { list.innerHTML = '<li style="text-align:center;color:var(--text-secondary);">Veri yok</li>'; return; }
            sorted.forEach(([k,c]) => {
                list.innerHTML += `<li style="padding:8px; border-bottom:1px solid rgba(0,0,0,0.05); display:flex; justify-content:space-between;"><span>${k}</span><b>${c}</b></li>`;
            });
        }

        function updateTestStats() {
             const calc = (type, fn) => { const arr = tests.filter(t=>t.type===type).map(t=>t.totalNet); return arr.length ? fn(...arr).toFixed(2) : 0; };
             document.getElementById('tytAverageNet').innerText = calc('TYT', (...a)=>a.reduce((x,y)=>x+y,0)/a.length);
             document.getElementById('tytBestNet').innerText = calc('TYT', Math.max);
             document.getElementById('aytAverageNet').innerText = calc('AYT', (...a)=>a.reduce((x,y)=>x+y,0)/a.length);
             document.getElementById('aytBestNet').innerText = calc('AYT', Math.max);
        }

        // --- Theme Color Settings ---
        function applyTheme(hue) {
            document.documentElement.style.setProperty('--hue', hue);
            localStorage.setItem('themeHue', hue);
            
            document.querySelectorAll('.color-circle').forEach(c => c.classList.remove('active'));
            const activeCircle = document.querySelector(`.color-circle[data-hue="${hue}"]`);
            if(activeCircle) activeCircle.classList.add('active');
            
            drawCharts(); drawTestCharts();
        }

        // --- Event Listeners ---
        document.addEventListener('DOMContentLoaded', async () => {
            await initDB(); loadData();
            
            // Theme Init
            const savedHue = localStorage.getItem('themeHue') || '200';
            applyTheme(savedHue);
            if(localStorage.getItem('darkMode') === 'true') document.body.classList.add('dark-mode');

            // Navigation
            document.querySelectorAll('.dock-item').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    document.querySelectorAll('.dock-item').forEach(i => i.classList.remove('active'));
                    link.classList.add('active');
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    document.getElementById(link.dataset.page).classList.add('active');
                    if(link.dataset.page === 'testPage') updateTestUI();
                });
            });
            
            // Buttons
            document.getElementById('uploadArea').onclick = () => document.getElementById('fileInput').click();
            document.getElementById('btnSaveQuestions').onclick = saveQuestions;
            document.getElementById('btnSaveTestResult').onclick = saveTestResult;

            document.getElementById('testType').onchange = (e) => {
                const isTYT = e.target.value === 'TYT';
                document.getElementById('tytTestInputs').style.display = isTYT ? 'block' : 'none';
                document.getElementById('aytTestInputs').style.display = isTYT ? 'none' : 'block';
                document.getElementById('tytTotalQuestions').style.display = isTYT ? 'flex' : 'none';
                document.getElementById('aytTotalQuestions').style.display = isTYT ? 'none' : 'flex';
            };

            // Dynamic Inputs
            document.addEventListener('input', (e) => {
                if(e.target.classList.contains('count-input')) {
                    const l = e.target.dataset.lesson;
                    const total = parseInt(document.getElementById(`${l}Toplam`).value)||0;
                    const d = parseInt(document.querySelector(`.dogru-input[data-lesson='${l}']`).value)||0;
                    const y = parseInt(document.querySelector(`.yanlis-input[data-lesson='${l}']`).value)||0;
                    document.querySelector(`.bos-display[data-lesson='${l}']`).value = Math.max(0, total-d-y);
                }
            });

            // Filtering & Sorting
            document.getElementById('galleryTabs').onclick = (e) => {
                if(e.target.classList.contains('gallery-tab')) {
                    document.querySelectorAll('.gallery-tab').forEach(t => t.classList.remove('active'));
                    e.target.classList.add('active');
                    updateQuestionGrid();
                }
            };
            
            // Explicit Sorting Listeners
            document.getElementById('btnFilterExam').onclick = (e) => {
                const btn = e.target;
                if(filterExamState === 'all') { filterExamState='TYT'; btn.innerText='Oturum: TYT'; }
                else if(filterExamState === 'TYT') { filterExamState='AYT'; btn.innerText='Oturum: AYT'; }
                else { filterExamState='all'; btn.innerText='Oturum: Hepsi'; }
                updateQuestionGrid();
            };

            document.getElementById('btnSortDate').onclick = (e) => {
                currentSortType = 'date';
                dateSortDirection = dateSortDirection === 'desc' ? 'asc' : 'desc';
                e.target.innerText = `üóìÔ∏è Tarih (${dateSortDirection === 'desc' ? 'Y-E' : 'E-Y'})`;
                document.querySelectorAll('.sort-btn').forEach(b => b.classList.remove('active'));
                e.target.classList.add('active');
                updateQuestionGrid();
            };

            document.getElementById('btnSortDifficulty').onclick = (e) => {
                currentSortType = 'difficulty';
                difficultySortDirection = difficultySortDirection === 'desc' ? 'asc' : 'desc';
                document.querySelectorAll('.sort-btn').forEach(b => b.classList.remove('active'));
                e.target.classList.add('active');
                updateQuestionGrid();
            };

            // Card Interactions (Fix for q is undefined)
            const modal = document.getElementById('myModal');
            document.getElementById('questionGrid').onclick = (e) => {
                const card = e.target.closest('.question-card');
                if(!card) return;
                
                const id = card.dataset.questionId;
                
                if(e.target.classList.contains('delete-btn')) {
                    e.stopPropagation();
                    if(confirm('Soruyu silmek istediƒüine emin misin?')) { 
                        deleteFromDB(QUESTION_STORE, id).then(() => { 
                            questions = questions.filter(q => q.id !== id); 
                            updateUI(); 
                        }); 
                    }
                } else {
                    const q = questions.find(x => x.id === id);
                    if(!q) return; // FIX
                    
                    currentQuestionId = q.id;
                    document.getElementById('modalImage').src = q.image;
                    document.getElementById('modalDate').innerText = new Date(q.date).toLocaleDateString();
                    document.getElementById('modalSource').innerText = q.kaynak || '-';
                    document.getElementById('modalComment').innerText = q.yorum || '-';
                    document.getElementById('modalDurumSelect').value = q.durum;
                    
                    document.getElementById('modalTags').innerHTML = `
                        <span class="tag-pill tag-sinav">${q.sinav}</span>
                        <span class="tag-pill tag-brans">${q.brans}</span>
                        <span class="tag-pill tag-zorluk ${q.zorluk}">${q.zorluk}</span>
                    `;

                    const solImg = document.getElementById('solutionImage');
                    solImg.src = q.solution || '';
                    solImg.style.display = q.solution ? 'block' : 'none';
                    document.getElementById('noSolutionText').style.display = q.solution ? 'none' : 'block';
                    
                    modal.style.display = 'flex';
                }
            };
            
            // Modal Actions
            document.getElementById('modalCloseBtn').onclick = () => modal.style.display = 'none';
            document.getElementById('btnUpdateStatus').onclick = async () => {
                const q = questions.find(x => x.id === currentQuestionId);
                q.durum = document.getElementById('modalDurumSelect').value;
                await updateInDB(QUESTION_STORE, q); updateUI(); modal.style.display = 'none';
            };
            document.getElementById('btnSaveSolution').onclick = () => {
                const f = document.getElementById('solutionInput').files[0];
                if(f) {
                    const r = new FileReader();
                    r.onload = async(ev) => {
                        const q = questions.find(x => x.id === currentQuestionId);
                        q.solution = ev.target.result;
                        await updateInDB(QUESTION_STORE, q); updateUI(); modal.style.display = 'none';
                    };
                    r.readAsDataURL(f);
                }
            };
            
            // Deletion inside modal
            document.getElementById('btnDeleteQuestion').onclick = () => {
                if(confirm('Silinsin mi?')) {
                    deleteFromDB(QUESTION_STORE, currentQuestionId).then(() => {
                        questions = questions.filter(q => q.id !== currentQuestionId);
                        updateUI();
                        modal.style.display = 'none';
                    });
                }
            };

            // Fullscreen
            document.getElementById('modalImage').onclick = () => { document.getElementById('fullscreenModalContent').src=document.getElementById('modalImage').src; document.getElementById('fullscreenModal').style.display='flex'; };
            document.getElementById('solutionImage').onclick = () => { document.getElementById('fullscreenModalContent').src=document.getElementById('solutionImage').src; document.getElementById('fullscreenModal').style.display='flex'; };
            document.getElementById('fullscreenCloseBtn').onclick = () => document.getElementById('fullscreenModal').style.display='none';

            // Weekly Goal
            document.getElementById('btnSetGoal').onclick = () => {
                localStorage.setItem('weeklyQuestionGoal', document.getElementById('weeklyGoalInput').value);
                updateWeeklyGoalStatus();
            };

            // Backup
            document.getElementById('btnExport').onclick = async () => {
               const data = { questions: await getAllFromDB(QUESTION_STORE), tests: await getAllFromDB(TEST_STORE) };
               const a = document.createElement('a');
               a.href = URL.createObjectURL(new Blob([JSON.stringify(data)], {type:'application/json'}));
               a.download = 'yks_yedek.json'; a.click();
            };
            document.getElementById('btnImport').onclick = () => document.getElementById('importFile').click();
            document.getElementById('importFile').onchange = (e) => {
                const r = new FileReader();
                r.onload = async (ev) => {
                    const d = JSON.parse(ev.target.result);
                    if(confirm('Mevcut veriler silinip yedek y√ºklenecek. Onaylƒ±yor musunuz?')) {
                        const tx = db.transaction([QUESTION_STORE, TEST_STORE], 'readwrite');
                        tx.objectStore(QUESTION_STORE).clear(); tx.objectStore(TEST_STORE).clear();
                        d.questions.forEach(q=>tx.objectStore(QUESTION_STORE).add(q));
                        d.tests.forEach(t=>tx.objectStore(TEST_STORE).add(t));
                        tx.oncomplete = () => location.reload();
                    }
                };
                r.readAsText(e.target.files[0]);
            };

            // Dark Mode
            document.getElementById('darkModeToggle').onclick = () => {
                document.body.classList.toggle('dark-mode');
                localStorage.setItem('darkMode', document.body.classList.contains('dark-mode'));
                drawCharts(); drawTestCharts();
            };

            // Settings Modal
            const setModal = document.getElementById('settingsModal');
            document.getElementById('settingsBtn').onclick = () => setModal.style.display = 'flex';
            document.getElementById('settingsCloseBtn').onclick = () => setModal.style.display = 'none';
            
            document.querySelectorAll('.color-circle').forEach(circle => {
                circle.onclick = (e) => {
                    applyTheme(e.target.dataset.hue);
                };
            });
            document.getElementById('btnResetTheme').onclick = () => applyTheme('200');

            // Subject Modal Logic
            let currentLessonForSub = null;
            document.querySelectorAll('.btn-add-subject').forEach(btn => {
                btn.onclick = (e) => {
                    currentLessonForSub = e.target.dataset.lesson;
                    const yanlis = parseInt(document.querySelector(`.yanlis-input[data-lesson='${currentLessonForSub}']`).value)||0;
                    const bos = parseInt(document.querySelector(`.bos-display[data-lesson='${currentLessonForSub}']`).value)||0;
                    document.getElementById('mistakeCount').innerText = yanlis + bos;
                    document.getElementById('subjectTagsContainer').innerHTML = (tempMistakeSubjects[currentLessonForSub]||[]).map(s=>`<span class="tag-pill" style="background:var(--glass-bg);">${s}</span>`).join('');
                    document.getElementById('subjectModal').style.display = 'flex';
                };
            });
            document.getElementById('saveSubjectsBtn').onclick = () => document.getElementById('subjectModal').style.display='none';
            document.getElementById('subjectInput').onkeydown = (e) => {
                if(e.key === 'Enter') {
                    if(!tempMistakeSubjects[currentLessonForSub]) tempMistakeSubjects[currentLessonForSub] = [];
                    tempMistakeSubjects[currentLessonForSub].push(e.target.value);
                    document.getElementById('subjectTagsContainer').innerHTML += `<span class="tag-pill" style="background:var(--glass-bg);">${e.target.value}</span>`;
                    e.target.value = '';
                }
            };
            document.getElementById('subjectModalCloseBtn').onclick = () => document.getElementById('subjectModal').style.display='none';

            // Test Details
             document.getElementById('testListContainer').onclick = (e) => {
                if(e.target.classList.contains('test-delete-btn')) {
                     e.stopPropagation();
                     deleteFromDB(TEST_STORE, e.target.dataset.testid).then(() => { tests = tests.filter(t=>t.id!==e.target.dataset.testid); updateTestUI(); });
                     return;
                }
                const item = e.target.closest('.test-list-item');
                if(item) {
                    const t = tests.find(x=>x.id===item.dataset.testid);
                    document.getElementById('testDetailModalTitle').innerText = t.name;
                    let html = '';
                    for(const [l, res] of Object.entries(t.results)) {
                        html += `<div style="margin-bottom:10px; border-bottom:1px solid rgba(0,0,0,0.1); padding-bottom:5px;">
                        <span style="font-weight:bold; color:var(--primary-accent); text-transform:uppercase;">${l.replace('tyt','').replace('ayt','')}</span>: 
                        D:${res.dogru} Y:${res.yanlis} Net:${res.net} <br> 
                        <small style="color:var(--text-secondary);">${(res.mistakeSubjects||[]).join(', ')}</small></div>`;
                    }
                    document.getElementById('testDetailModalBody').innerHTML = html;
                    document.getElementById('testDetailModal').style.display='flex';
                }
            };
            document.getElementById('testDetailModalCloseBtn').onclick = () => document.getElementById('testDetailModal').style.display='none';
        });
    </script>
</body>
</html>
