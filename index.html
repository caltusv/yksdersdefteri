<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YKS Dijital Hata Defteri & Deneme Takip</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-color: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --header-color: white;
            --main-text-color: #333;
            --container-bg: rgba(255, 255, 255, 0.95);
            --section-title-color: #4a5568;
            --section-border-color: #e2e8f0;
            --upload-area-bg: #f8fafc;
            --upload-area-border: #cbd5e0;
            --upload-area-text: #a0aec0;
            --input-border: #e2e8f0;
            --input-focus-border: #667eea;
            --input-focus-shadow: rgba(102, 126, 234, 0.1);
            --btn-primary-bg: linear-gradient(45deg, #667eea, #764ba2);
            --btn-secondary-bg: #e2e8f0;
            --btn-secondary-text: #4a5568;
            --card-bg: white;
            --card-shadow: rgba(0,0,0,0.1);
            --tag-sinav-bg: #fed7d7;
            --tag-sinav-text: #c53030;
            --tag-brans-bg: #c6f6d5;
            --tag-brans-text: #22543d;
            --tag-konu-bg: #bee3f8;
            --tag-konu-text: #2a69ac;
            --tag-durum-bg: #fbb6ce;
            --tag-durum-text: #97266d;
            --tag-durum-cozuldu-bg: #c6f6d5;
            --tag-durum-cozuldu-text: #22543d;
            --tag-durum-yarim-bg: #faf089;
            --tag-durum-yarim-text: #744210;
            --tag-zorluk-bg: #e9d8fd;
            --tag-zorluk-text: #553c9a;
            --question-comment-bg: #f0f8ff;
            --question-comment-text: #2d3748;
            --question-comment-border: #4299e1;
            --question-source-text: #718096;
            --modal-bg: rgba(0,0,0,0.9);
            --modal-content-bg: white;
            --modal-header-bg: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --modal-header-text: white;
            --modal-body-bg: #f8fafc;
            --modal-details-bg: white;
            --detail-content-bg: #f8fafc;
            --detail-content-border: #667eea;
            --nav-menu-bg: rgba(255, 255, 255, 0.95);
            --nav-menu-item-bg: #e2e8f0;
            --nav-menu-item-text: #4a5568;
            --nav-menu-item-hover-bg: #cbd5e0;
            --test-results-bg: #f8fafc;
            --test-results-net-color: #667eea;
            --test-list-item-bg: #f8fafc;
            --test-net-color: #764ba2;
            --empty-state-text: #718096;
            --sun-moon-color: #FFD700;
        }

        .dark-mode {
            --bg-color: #1a202c;
            --header-color: #e2e8f0;
            --main-text-color: #e2e8f0;
            --container-bg: #2d3748;
            --section-title-color: #e2e8f0;
            --section-border-color: #4a5568;
            --upload-area-bg: #2d3748;
            --upload-area-border: #4a5568;
            --upload-area-text: #a0aec0;
            --input-border: #4a5568;
            --input-focus-border: #9f7aea;
            --input-focus-shadow: rgba(159, 122, 234, 0.2);
            --btn-primary-bg: linear-gradient(45deg, #9f7aea, #d6bcfa);
            --btn-secondary-bg: #4a5568;
            --btn-secondary-text: #e2e8f0;
            --card-bg: #2d3748;
            --card-shadow: rgba(0,0,0,0.4);
            --tag-sinav-bg: #c53030;
            --tag-sinav-text: #fed7d7;
            --tag-brans-bg: #22543d;
            --tag-brans-text: #c6f6d5;
            --tag-konu-bg: #2a69ac;
            --tag-konu-text: #bee3f8;
            --tag-durum-bg: #97266d;
            --tag-durum-text: #fbb6ce;
            --tag-durum-cozuldu-bg: #22543d;
            --tag-durum-cozuldu-text: #c6f6d5;
            --tag-durum-yarim-bg: #744210;
            --tag-durum-yarim-text: #faf089;
            --tag-zorluk-bg: #553c9a;
            --tag-zorluk-text: #e9d8fd;
            --question-comment-bg: #2a4365;
            --question-comment-text: #e2e8f0;
            --question-comment-border: #4299e1;
            --question-source-text: #a0aec0;
            --modal-bg: rgba(0,0,0,0.9);
            --modal-content-bg: #2d3748;
            --modal-header-bg: linear-gradient(135deg, #4a5568 0%, #2d3748 100%);
            --modal-header-text: #e2e8f0;
            --modal-body-bg: #1a202c;
            --modal-details-bg: #2d3748;
            --detail-content-bg: #4a5568;
            --detail-content-border: #9f7aea;
            --nav-menu-bg: #2d3748;
            --nav-menu-item-bg: #4a5568;
            --nav-menu-item-text: #e2e8f0;
            --nav-menu-item-hover-bg: #6a7483;
            --test-results-bg: #2d3748;
            --test-results-net-color: #9f7aea;
            --test-list-item-bg: #2d3748;
            --test-net-color: #d6bcfa;
            --empty-state-text: #a0aec0;
            --sun-moon-color: #FFD700;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-color);
            min-height: 100vh;
            color: var(--main-text-color);
            transition: background 0.5s ease, color 0.5s ease;
        }
        
        input, select, textarea {
            background-color: var(--card-bg);
            color: var(--main-text-color);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: var(--header-color);
            position: relative;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .hamburger {
            position: absolute;
            top: 20px;
            left: 20px;
            font-size: 2rem;
            color: var(--header-color);
            cursor: pointer;
            z-index: 20;
        }
        
        .dark-mode-toggle {
            position: absolute;
            top: 25px;
            right: 25px;
            font-size: 1.5rem;
            cursor: pointer;
            z-index: 20;
            color: var(--sun-moon-color);
        }

        .nav-menu {
            position: fixed;
            top: 0;
            left: -300px;
            width: 250px;
            height: 100%;
            background: var(--nav-menu-bg);
            padding: 20px;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
            transition: left 0.3s ease-in-out;
            z-index: 15;
        }
        
        .nav-menu.active {
            left: 0;
        }
        
        .nav-menu a {
            display: block;
            padding: 15px;
            margin-bottom: 10px;
            background: var(--nav-menu-item-bg);
            border-radius: 10px;
            text-decoration: none;
            color: var(--nav-menu-item-text);
            font-weight: 600;
            transition: all 0.2s ease;
        }
        
        .nav-menu a:hover {
            background: var(--nav-menu-item-hover-bg);
            transform: translateX(5px);
        }

        .summary-container {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .main-page-content {
            display: grid;
            grid-template-columns: 400px 1fr;
            gap: 30px;
            align-items: flex-start;
        }

        .left-column, .right-column {
            display: flex;
            flex-direction: column;
            gap: 30px;
        }

        .upload-section, .filter-section, .test-section, .goals-section, .repeat-section, .gallery, .chart-container {
            background: var(--container-bg);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 10px 30px var(--card-shadow);
            backdrop-filter: blur(10px);
        }

        .section-title {
            font-size: 1.3rem;
            margin-bottom: 20px;
            color: var(--section-title-color);
            border-bottom: 2px solid var(--section-border-color);
            padding-bottom: 10px;
        }

        .upload-area {
            border: 3px dashed var(--upload-area-border);
            border-radius: 15px;
            padding: 40px 20px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            background: var(--upload-area-bg);
        }

        .upload-area:hover {
            border-color: var(--input-focus-border);
            background: var(--section-border-color);
            transform: translateY(-2px);
        }
        
        .dark-mode .upload-area:hover {
            background: var(--nav-menu-item-bg);
        }

        .upload-area.dragover {
            border-color: var(--input-focus-border);
            background: #e6fffa;
            transform: scale(1.02);
        }

        .upload-icon {
            font-size: 3rem;
            margin-bottom: 15px;
            color: var(--upload-area-text);
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        label {
            font-weight: 600;
            margin-bottom: 5px;
            color: var(--section-title-color);
        }

        select, input, textarea {
            padding: 12px;
            border: 2px solid var(--input-border);
            border-radius: 10px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
            width: 100%;
        }
        
        input[disabled] {
            background-color: var(--upload-area-bg);
            cursor: not-allowed;
            opacity: 0.7;
        }

        select:focus, input:focus, textarea:focus {
            outline: none;
            border-color: var(--input-focus-border);
            box-shadow: 0 0 0 3px var(--input-focus-shadow);
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 15px;
        }

        .btn-primary {
            background: var(--btn-primary-bg);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: var(--btn-secondary-bg);
            color: var(--btn-secondary-text);
        }

        .btn-secondary:hover {
            background: var(--nav-menu-item-hover-bg);
        }

        .question-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .question-card {
            background: var(--card-bg);
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 5px 20px var(--card-shadow);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .question-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px var(--card-shadow);
        }

        .question-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
            background: var(--upload-area-bg);
        }

        .question-info {
            padding: 15px;
            position: relative;
        }

        .question-comment {
            background: var(--question-comment-bg);
            padding: 12px;
            margin: 10px 0;
            border-radius: 10px;
            font-size: 0.9rem;
            color: var(--question-comment-text);
            border-left: 4px solid var(--question-comment-border);
            line-height: 1.4;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .question-comment::before {
            content: "💭 ";
            font-size: 1rem;
        }

        .question-source {
            font-size: 0.8rem;
            color: var(--question-source-text);
            margin-top: 8px;
        }

        .question-source::before {
            content: "📚 ";
        }

        .question-solution-indicator {
            background: var(--tag-durum-cozuldu-bg);
            color: var(--tag-durum-cozuldu-text);
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
            margin-top: 5px;
            display: inline-block;
        }

        .question-solution-indicator::before {
            content: "✅ ";
        }

        .question-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 10px;
        }

        .tag {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .tag-sinav {
            background: var(--tag-sinav-bg);
            color: var(--tag-sinav-text);
        }

        .tag-brans {
            background: var(--tag-brans-bg);
            color: var(--tag-brans-text);
        }

        .tag-konu {
            background: var(--tag-konu-bg);
            color: var(--tag-konu-text);
        }

        .tag-durum {
            background: var(--tag-durum-bg);
            color: var(--tag-durum-text);
        }

        .tag-durum.cozuldu {
            background: var(--tag-durum-cozuldu-bg);
            color: var(--tag-durum-cozuldu-text);
        }

        .tag-durum.yarim {
            background: var(--tag-durum-yarim-bg);
            color: var(--tag-durum-yarim-text);
        }

        .tag-zorluk {
            background: var(--tag-zorluk-bg);
            color: var(--tag-zorluk-text);
        }

        .tag-zorluk.kolay {
            background: var(--tag-durum-cozuldu-bg);
            color: var(--tag-durum-cozuldu-text);
        }

        .tag-zorluk.orta {
            background: var(--tag-durum-bg);
            color: var(--tag-durum-text);
        }

        .tag-zorluk.zor {
            background: var(--tag-sinav-bg);
            color: var(--tag-sinav-text);
        }
        
        .tag-tekrar {
            background: #d4f7dc;
            color: #2f855a;
        }
        .dark-mode .tag-tekrar {
            background: #2f855a;
            color: #d4f7dc;
        }

        .question-date {
            font-size: 0.9rem;
            color: var(--question-source-text);
            margin-top: 10px;
        }

        .delete-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255, 0, 0, 0.9);
            color: white;
            border: none;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            cursor: pointer;
            font-size: 1.2rem;
            opacity: 0;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
            font-weight: bold;
        }

        .delete-btn:hover {
            background: rgba(255, 0, 0, 1);
            transform: scale(1.1);
        }

        .question-card:hover .delete-btn {
            opacity: 1;
        }

        .question-card {
            position: relative;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            background: var(--container-bg);
            padding: 20px;
            border-radius: 20px;
            box-shadow: 0 10px 30px var(--card-shadow);
        }

        .stat-card {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 5px 15px var(--card-shadow);
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: var(--test-results-net-color);
        }

        .stat-label {
            color: var(--question-source-text);
            margin-top: 5px;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: var(--modal-bg);
            backdrop-filter: blur(5px);
            overflow-y: auto;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            position: relative;
            margin: 20px auto;
            width: 90vw;
            max-width: 1400px;
            background: var(--modal-content-bg);
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
            overflow: hidden;
        }

        .modal-header {
            background: var(--modal-header-bg);
            color: var(--modal-header-text);
            padding: 20px;
            position: relative;
        }

        .modal-title {
            font-size: 1.3rem;
            font-weight: bold;
            margin: 0;
        }

        .modal-subtitle {
            opacity: 0.9;
            margin-top: 5px;
            font-size: 0.9rem;
        }

        .close {
            position: absolute;
            top: 15px;
            right: 20px;
            color: var(--modal-header-text);
            font-size: 30px;
            font-weight: bold;
            cursor: pointer;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .close:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.1);
        }

        .modal-body {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 0;
            min-height: 500px;
        }

        .modal-image-container {
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--modal-body-bg);
        }

        .modal-image {
            max-width: 100%;
            max-height: 70vh;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            object-fit: contain;
        }

        .modal-details {
            background: var(--modal-details-bg);
            padding: 30px;
            border-left: 2px solid var(--section-border-color);
            overflow-y: auto;
            max-height: 80vh;
        }

        .detail-section {
            margin-bottom: 25px;
        }

        .detail-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--section-title-color);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .detail-content {
            background: var(--detail-content-bg);
            padding: 12px;
            border-radius: 8px;
            font-size: 0.9rem;
            color: var(--main-text-color);
            border-left: 4px solid var(--detail-content-border);
        }

        .modal-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 20px;
        }

        .status-changer {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 20px;
        }

        .modal-btn {
            padding: 10px 15px;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-status {
            background: var(--btn-primary-bg);
            color: white;
        }

        .btn-delete {
            background: linear-gradient(45deg, #e53e3e, #c53030);
            color: white;
        }

        .btn-status:hover, .btn-delete:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        
        @media (max-width: 1024px) {
            .summary-container, .main-page-content {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 1024px) {
            .modal-body {
                grid-template-columns: 1fr;
            }
            
            .modal-details {
                border-left: none;
                border-top: 2px solid var(--section-border-color);
                max-height: none;
            }
            
            .modal-image-container {
                min-height: 300px;
            }
        }

        @media (max-width: 768px) {
            .modal-content {
                margin: 10px;
                width: calc(100% - 20px);
                max-width: none;
            }
            .modal-header {
                padding: 15px;
            }
            .modal-details {
                padding: 20px;
            }
            .header h1 {
                font-size: 2rem;
            }
            .question-grid {
                grid-template-columns: 1fr;
            }
             .delete-btn {
                opacity: 0.8;
            }
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--empty-state-text);
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        #fileInput {
            display: none;
        }

        .filter-active {
            background: #667eea !important;
            color: white !important;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .test-input-grid {
            display: grid;
            grid-template-columns: 1fr 1.5fr 0.5fr;
            gap: 15px;
            align-items: center;
        }
        
        .test-input-grid label {
            grid-column: 1 / 2;
        }

        .test-input-grid .input-group {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
            grid-column: 2 / 3;
        }

        .test-input-grid .btn-add-subject {
            grid-column: 3 / 4;
            padding: 10px;
            font-size: 0.8rem;
            margin-top: 0;
        }

        .test-input-grid input {
            flex-grow: 1;
        }
        
        .test-results {
            margin-top: 20px;
            display: grid;
            gap: 10px;
            background: var(--test-results-bg);
            padding: 15px;
            border-radius: 10px;
        }
        
        .test-results-item {
            display: flex;
            justify-content: space-between;
            font-size: 1rem;
            font-weight: 500;
        }
        
        .test-results-item span:last-child {
            font-weight: 700;
            color: var(--test-results-net-color);
        }

        .test-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: var(--test-list-item-bg);
            border-radius: 10px;
            margin-bottom: 10px;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
        }
        
        .test-list-item:hover {
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            transform: translateY(-2px);
        }
        
        .test-info {
            font-size: 1rem;
            color: var(--section-title-color);
        }
        
        .test-info .date {
            font-size: 0.8rem;
            color: var(--question-source-text);
            margin-top: 5px;
        }
        
        .test-net {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--test-net-color);
        }
        
        #tytChartContainer, #aytChartContainer {
            margin-top: 30px;
            padding: 20px;
            background: var(--card-bg);
            border-radius: 20px;
            box-shadow: 0 5px 15px var(--card-shadow);
        }
        
        #solutionImage {
            cursor: zoom-in;
            transition: transform 0.3s ease;
            max-width: 100%;
        }
        
        #solutionImage:hover {
            transform: scale(1.05);
        }

        #fullscreenModal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(5px);
            align-items: center;
            justify-content: center;
        }
        
        #fullscreenModalContent {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
            box-shadow: 0 0 40px rgba(0,0,0,0.5);
            border-radius: 10px;
        }
        
        .fullscreen-close {
            position: absolute;
            top: 20px;
            right: 30px;
            color: #fff;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
            transition: 0.3s;
        }

        .fullscreen-close:hover,
        .fullscreen-close:focus {
            color: #bbb;
            text-decoration: none;
            cursor: pointer;
        }

        .test-delete-btn {
            position: absolute;
            top: 50%;
            right: 15px;
            transform: translateY(-50%);
            background: rgba(255, 0, 0, 0.7);
            color: white;
            border: none;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: bold;
            opacity: 0;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
        }

        .test-list-item:hover .test-delete-btn {
            opacity: 1;
        }

        .test-delete-btn:hover {
            background: rgba(255, 0, 0, 1);
            transform: translateY(-50%) scale(1.1);
        }

        /* YENİ EKLENEN CSS */
        .total-questions-settings {
            background: var(--test-results-bg);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
        }
        .total-questions-settings h4 {
            margin-bottom: 15px;
            color: var(--section-title-color);
        }
        .total-questions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }
        .total-q-group {
            display: flex;
            flex-direction: column;
        }
        .total-q-group label {
            font-size: 0.9rem;
            margin-bottom: 5px;
        }
        .total-q-group input {
            padding: 8px;
            font-size: 0.9rem;
        }

        #subjectTagsContainer .tag {
            cursor: pointer;
            position: relative;
            padding-right: 25px;
            background-color: var(--tag-konu-bg);
            color: var(--tag-konu-text);
        }

        #subjectTagsContainer .tag::after {
            content: '×';
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            font-weight: bold;
        }

    </style>
</head>
<body>
    <div class="hamburger" id="hamburgerMenu">☰</div>
    <div class="dark-mode-toggle" id="darkModeToggle">☀️</div>
    <div class="nav-menu" id="navMenu">
        <a href="#" data-page="questionPage">📚 Soru Defterim</a>
        <a href="#" data-page="testPage">📈 Deneme Takip Sistemi</a>
    </div>

    <div class="container" id="main-container">
        <div class="header">
            <h1>📚 YKS Dijital Hata Defteri & Deneme Takip</h1>
            <p id="sub-header-text">Çözümünü anlayamadığınız soruları organize edin ve tekrar edin</p>
        </div>
        
        <div id="questionPage" class="tab-content active">
            <div class="summary-container">
                <div class="stats">
                    <div class="stat-card">
                        <div class="stat-number" id="totalQuestions">0</div>
                        <div class="stat-label">Toplam Soru</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="tytQuestions">0</div>
                        <div class="stat-label">TYT Soruları</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="aytQuestions">0</div>
                        <div class="stat-label">AYT Soruları</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="solvedQuestions">0</div>
                        <div class="stat-label">Çözülmüş</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="todayQuestions">0</div>
                        <div class="stat-label">Bugün Eklenen</div>
                    </div>
                     <div class="stat-card">
                        <div class="stat-number" id="hardQuestions">0</div>
                        <div class="stat-label">Zor Sorular</div>
                    </div>
                </div>
                 <div class="goals-section">
                    <h2 class="section-title">🎯 Haftalık Hedefler & Seriler</h2>
                    <div style="display: flex; flex-direction: column; gap: 15px;">
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <label for="weeklyGoalInput">Haftalık Soru Hedefi</label>
                            <input type="number" id="weeklyGoalInput" placeholder="50" style="width: 100px;">
                            <button class="btn btn-primary" id="btnSetGoal">Belirle</button>
                        </div>
                        <div>
                            <p id="weeklyGoalStatus">Hedef: Belirlenmedi</p>
                        </div>
                    </div>
                    <div class="stat-card" style="margin-top: 20px;">
                        <div class="stat-number" id="streakCounter">0</div>
                        <div class="stat-label">🔥 Günlük Soru Ekleme Serin</div>
                    </div>
                </div>
            </div>

            <div class="main-page-content">
                <div class="left-column">
                    <div class="upload-section">
                        <h2 class="section-title">➕ Yeni Soru Ekle</h2>
                        <div class="upload-area" id="uploadArea">
                            <div class="upload-icon">📁</div>
                            <p>Soru görselini buraya sürükleyin veya tıklayın</p>
                            <p style="font-size: 0.9rem; color: #718096; margin-top: 10px;">
                                <span style="font-weight: bold;">İpucu:</span> Mobil cihazlarda bu işlem telefon kamerasını açabilir.
                            </p>
                        </div>
                        <input type="file" id="fileInput" accept="image/*" multiple>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="sinavOturumu">Sınav Oturumu</label>
                                <select id="sinavOturumu">
                                    <option value="TYT">TYT</option>
                                    <option value="AYT">AYT</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="brans">Branş</label>
                                <select id="brans">
                                    <option value="Matematik">Matematik</option>
                                    <option value="Fizik">Fizik</option>
                                    <option value="Kimya">Kimya</option>
                                    <option value="Biyoloji">Biyoloji</option>
                                    <option value="Türkçe">Türkçe</option>
                                    <option value="Tarih">Tarih</option>
                                    <option value="Coğrafya">Coğrafya</option>
                                    <option value="Felsefe">Felsefe</option>
                                    <option value="Edebiyat">Edebiyat</option>
                                    <option value="Geometri">Geometri</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="konu">Konu</label>
                            <input type="text" id="konu" placeholder="Örn: Limit, Denge, Mol Kavramı...">
                        </div>
                        <div class="form-group">
                            <label for="durum">Durum</label>
                            <select id="durum">
                                <option value="cozulmedi">❌ Çözülmedi</option>
                                <option value="yarim">⚠️ Yarım Anladım</option>
                                <option value="cozuldu">✅ Çözüldü</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="zorluk">Zorluk Seviyesi</label>
                            <select id="zorluk">
                                <option value="kolay">🟢 Kolay</option>
                                <option value="orta">🟡 Orta</option>
                                <option value="zor">🔴 Zor</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="repeatDate">Tekrar Tarihi (Opsiyonel)</label>
                            <input type="date" id="repeatDate">
                        </div>
                        <div class="form-group">
                            <label for="yorum">Kişisel Notlarım</label>
                            <textarea id="yorum" placeholder="Bu soruyu neden ekledim? Hangi kısmı zorlandım? Çözüm ipucu..." rows="3" style="resize: vertical;"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="kaynak">Kaynak (Opsiyonel)</label>
                            <input type="text" id="kaynak" placeholder="Örn: TYT 2023 Deneme 5...">
                        </div>
                        <button class="btn btn-primary" id="btnSaveQuestions">💾 Soruları Kaydet</button>
                    </div>

                    <div class="filter-section">
                        <h2 class="section-title">🔍 Filtreleme</h2>
                        <div class="form-group">
                            <label for="filterSearchText">Genel Arama</label>
                            <input type="text" id="filterSearchText" placeholder="Konu, yorum veya kaynakta ara...">
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Sınav Oturumu</label>
                                <select id="filterSinav">
                                    <option value="">Tümü</option>
                                    <option value="TYT">TYT</option>
                                    <option value="AYT">AYT</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Branş</label>
                                <select id="filterBrans">
                                    <option value="">Tümü</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Durum</label>
                            <select id="filterDurum">
                                    <option value="">Tümü</option>
                                <option value="cozulmedi">❌ Çözülmedi</option>
                                <option value="yarim">⚠️ Yarım Anladım</option>
                                <option value="cozuldu">✅ Çözüldü</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Zorluk Seviyesi</label>
                            <select id="filterZorluk">
                                <option value="">Tümü</option>
                                <option value="kolay">🟢 Kolay</option>
                                <option value="orta">🟡 Orta</option>
                                <option value="zor">🔴 Zor</option>
                            </select>
                        </div>
                        <button class="btn btn-secondary" id="btnClearFilters">🗑️ Filtreleri Temizle</button>
                        <button class="btn btn-secondary" id="btnExport" style="margin-left: 10px;">📤 Dışa Aktar</button>
                        <button class="btn btn-secondary" id="btnImport" style="margin-left: 10px;">📥 İçe Aktar</button>
                        <input type="file" id="importFile" accept=".json" style="display: none;">
                    </div>

                    <div class="chart-container">
                        <h3 style="text-align: center; margin-bottom: 20px; color: var(--section-title-color);">Soru Dağılımları</h3>
                        <div style="display: flex; justify-content: space-around; flex-wrap: wrap; gap: 20px;">
                            <div style="width: 100%; max-width: 400px; height: 400px;">
                                <canvas id="bransChart"></canvas>
                            </div>
                            <div style="width: 100%; max-width: 400px; height: 400px;">
                                <canvas id="zorlukChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="right-column">
                    <div class="repeat-section">
                        <h2 class="section-title">🗓️ Bugün Tekrar Etmen Gereken Sorular</h2>
                        <div class="question-grid" id="repeatQuestionGrid">
                            <div class="empty-state">
                                <div class="empty-state-icon">🎉</div>
                                <h3>Bugün tekrar etmen gereken soru yok!</h3>
                                <p>Tekrar tarihi belirlediğin sorular burada görünecek.</p>
                            </div>
                        </div>
                    </div>
                    <div class="gallery">
                        <h2 class="section-title">📖 Soru Galerim</h2>
                        <div class="question-grid" id="questionGrid">
                            <div class="empty-state">
                                <div class="empty-state-icon">📝</div>
                                <h3>Henüz soru eklenmedi</h3>
                                <p>Yukarıdan soru görseli yükleyerek başlayın!</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="testPage" class="tab-content">
            <div class="test-section">
                <h2 class="section-title">📝 Yeni Deneme Sonucu Ekle</h2>
                <div class="form-group">
                    <label for="testType">Sınav Oturumu</label>
                    <select id="testType">
                        <option value="TYT">TYT</option>
                        <option value="AYT">AYT</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="testName">Deneme Adı</label>
                    <input type="text" id="testName" placeholder="Örn: 3D Yayınları Deneme 5">
                </div>
                
                <div class="total-questions-settings">
                    <h4>📝 Derslerin Toplam Soru Sayıları</h4>
                    <div id="tytTotalQuestions" class="total-questions-grid">
                        <div class="total-q-group"><label>Matematik</label><input type="number" class="total-q-input" data-lesson="tytMat" id="tytMatToplam" value="40"></div>
                        <div class="total-q-group"><label>Türkçe</label><input type="number" class="total-q-input" data-lesson="tytTurkce" id="tytTurkceToplam" value="40"></div>
                        <div class="total-q-group"><label>Sosyal</label><input type="number" class="total-q-input" data-lesson="tytSosyal" id="tytSosyalToplam" value="20"></div>
                        <div class="total-q-group"><label>Fen</label><input type="number" class="total-q-input" data-lesson="tytFen" id="tytFenToplam" value="20"></div>
                    </div>
                    <div id="aytTotalQuestions" class="total-questions-grid" style="display: none;">
                        <div class="total-q-group"><label>Matematik</label><input type="number" class="total-q-input" data-lesson="aytMat" id="aytMatToplam" value="40"></div>
                        <div class="total-q-group"><label>Fizik</label><input type="number" class="total-q-input" data-lesson="aytFizik" id="aytFizikToplam" value="14"></div>
                        <div class="total-q-group"><label>Kimya</label><input type="number" class="total-q-input" data-lesson="aytKimya" id="aytKimyaToplam" value="13"></div>
                        <div class="total-q-group"><label>Biyoloji</label><input type="number" class="total-q-input" data-lesson="aytBiyoloji" id="aytBiyolojiToplam" value="13"></div>
                        <div class="total-q-group"><label>Edebiyat</label><input type="number" class="total-q-input" data-lesson="aytEdebiyat" id="aytEdebiyatToplam" value="24"></div>
                        <div class="total-q-group"><label>Coğrafya</label><input type="number" class="total-q-input" data-lesson="aytCografya" id="aytCografyaToplam" value="6"></div>
                    </div>
                </div>

                <hr style="margin: 20px 0; border: none; border-top: 1px dashed var(--section-border-color);">

                <div id="tytTestInputs" class="test-inputs">
                    <h3>TYT Dersleri</h3>
                    <div class="test-input-grid">
                        <label>Matematik</label>
                        <div class="input-group">
                            <input type="number" data-lesson="tytMat" class="dogru-input count-input" placeholder="Doğru">
                            <input type="number" data-lesson="tytMat" class="yanlis-input count-input" placeholder="Yanlış">
                            <input type="number" data-lesson="tytMat" class="bos-display" placeholder="Boş" disabled>
                        </div>
                        <button class="btn btn-secondary btn-add-subject" data-lesson="tytMat">Konu Ekle</button>
                        
                        <label>Türkçe</label>
                        <div class="input-group">
                            <input type="number" data-lesson="tytTurkce" class="dogru-input count-input" placeholder="Doğru">
                            <input type="number" data-lesson="tytTurkce" class="yanlis-input count-input" placeholder="Yanlış">
                            <input type="number" data-lesson="tytTurkce" class="bos-display" placeholder="Boş" disabled>
                        </div>
                        <button class="btn btn-secondary btn-add-subject" data-lesson="tytTurkce">Konu Ekle</button>

                        <label>Sosyal</label>
                        <div class="input-group">
                            <input type="number" data-lesson="tytSosyal" class="dogru-input count-input" placeholder="Doğru">
                            <input type="number" data-lesson="tytSosyal" class="yanlis-input count-input" placeholder="Yanlış">
                            <input type="number" data-lesson="tytSosyal" class="bos-display" placeholder="Boş" disabled>
                        </div>
                        <button class="btn btn-secondary btn-add-subject" data-lesson="tytSosyal">Konu Ekle</button>
                        
                        <label>Fen</label>
                        <div class="input-group">
                            <input type="number" data-lesson="tytFen" class="dogru-input count-input" placeholder="Doğru">
                            <input type="number" data-lesson="tytFen" class="yanlis-input count-input" placeholder="Yanlış">
                            <input type="number" data-lesson="tytFen" class="bos-display" placeholder="Boş" disabled>
                        </div>
                        <button class="btn btn-secondary btn-add-subject" data-lesson="tytFen">Konu Ekle</button>
                    </div>
                </div>
                <div id="aytTestInputs" class="test-inputs" style="display: none;">
                    <h3>AYT Dersleri</h3>
                    <div class="test-input-grid">
                         <label>Matematik</label>
                        <div class="input-group">
                            <input type="number" data-lesson="aytMat" class="dogru-input count-input" placeholder="Doğru">
                            <input type="number" data-lesson="aytMat" class="yanlis-input count-input" placeholder="Yanlış">
                            <input type="number" data-lesson="aytMat" class="bos-display" placeholder="Boş" disabled>
                        </div>
                        <button class="btn btn-secondary btn-add-subject" data-lesson="aytMat">Konu Ekle</button>
                        
                        <label>Fizik</label>
                        <div class="input-group">
                            <input type="number" data-lesson="aytFizik" class="dogru-input count-input" placeholder="Doğru">
                            <input type="number" data-lesson="aytFizik" class="yanlis-input count-input" placeholder="Yanlış">
                            <input type="number" data-lesson="aytFizik" class="bos-display" placeholder="Boş" disabled>
                        </div>
                        <button class="btn btn-secondary btn-add-subject" data-lesson="aytFizik">Konu Ekle</button>
                        
                        <label>Kimya</label>
                        <div class="input-group">
                           <input type="number" data-lesson="aytKimya" class="dogru-input count-input" placeholder="Doğru">
                            <input type="number" data-lesson="aytKimya" class="yanlis-input count-input" placeholder="Yanlış">
                            <input type="number" data-lesson="aytKimya" class="bos-display" placeholder="Boş" disabled>
                        </div>
                        <button class="btn btn-secondary btn-add-subject" data-lesson="aytKimya">Konu Ekle</button>
                        
                        <label>Biyoloji</label>
                        <div class="input-group">
                            <input type="number" data-lesson="aytBiyoloji" class="dogru-input count-input" placeholder="Doğru">
                            <input type="number" data-lesson="aytBiyoloji" class="yanlis-input count-input" placeholder="Yanlış">
                            <input type="number" data-lesson="aytBiyoloji" class="bos-display" placeholder="Boş" disabled>
                        </div>
                        <button class="btn btn-secondary btn-add-subject" data-lesson="aytBiyoloji">Konu Ekle</button>
                        
                        <label>Edebiyat</label>
                        <div class="input-group">
                            <input type="number" data-lesson="aytEdebiyat" class="dogru-input count-input" placeholder="Doğru">
                            <input type="number" data-lesson="aytEdebiyat" class="yanlis-input count-input" placeholder="Yanlış">
                            <input type="number" data-lesson="aytEdebiyat" class="bos-display" placeholder="Boş" disabled>
                        </div>
                        <button class="btn btn-secondary btn-add-subject" data-lesson="aytEdebiyat">Konu Ekle</button>
                        
                        <label>Coğrafya</label>
                        <div class="input-group">
                            <input type="number" data-lesson="aytCografya" class="dogru-input count-input" placeholder="Doğru">
                            <input type="number" data-lesson="aytCografya" class="yanlis-input count-input" placeholder="Yanlış">
                            <input type="number" data-lesson="aytCografya" class="bos-display" placeholder="Boş" disabled>
                        </div>
                        <button class="btn btn-secondary btn-add-subject" data-lesson="aytCografya">Konu Ekle</button>
                    </div>
                </div>
                <button class="btn btn-primary" id="btnSaveTestResult">💾 Deneme Sonucunu Kaydet</button>
            </div>
            <div class="test-section" style="margin-top: 30px;">
                <h2 class="section-title">📊 Deneme Sonuçlarım</h2>
                <div class="stats">
                    <div class="stat-card">
                        <div class="stat-number" id="tytAverageNet">0</div>
                        <div class="stat-label">TYT Ortalama Net</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="tytBestNet">0</div>
                        <div class="stat-label">TYT En İyi Net</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="aytAverageNet">0</div>
                        <div class="stat-label">AYT Ortalama Net</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="aytBestNet">0</div>
                        <div class="stat-label">AYT En İyi Net</div>
                    </div>
                </div>
                <div class="test-list-container" id="testListContainer">
                    </div>
            </div>
            <div class="chart-container" style="margin-top: 30px;">
                <h3 style="text-align: center; margin-bottom: 20px; color: var(--section-title-color);">Deneme Netlerinin Değişimi</h3>
                <div style="display: flex; flex-wrap: wrap; gap: 20px; justify-content: center;">
                    <div style="width: 400px; height: 400px;">
                        <canvas id="tytTotalChart"></canvas>
                    </div>
                    <div style="width: 400px; height: 400px;">
                        <canvas id="aytTotalChart"></canvas>
                    </div>
                    <div style="width: 400px; height: 400px;">
                        <canvas id="tytMatChart"></canvas>
                    </div>
                    <div style="width: 400px; height: 400px;">
                        <canvas id="tytTurkceChart"></canvas>
                    </div>
                    <div style="width: 400px; height: 400px;">
                        <canvas id="aytMatChart"></canvas>
                    </div>
                    <div style="width: 400px; height: 400px;">
                        <canvas id="aytFizikChart"></canvas>
                    </div>
                    <div style="width: 400px; height: 400px;">
                        <canvas id="aytKimyaChart"></canvas>
                    </div>
                    <div style="width: 400px; height: 400px;">
                        <canvas id="aytBiyolojiChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="myModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="close" id="modalCloseBtn">&times;</span>
                <h2 class="modal-title" id="modalTitle">Soru Detayları</h2>
                <p class="modal-subtitle" id="modalDate"></p>
            </div>
            <div class="modal-body">
                <div class="modal-image-container">
                    <img class="modal-image" id="modalImage" src="" alt="Soru Görseli">
                </div>
                <div class="modal-details">
                    <div class="modal-tags" id="modalTags"></div>
                    <div class="detail-section">
                        <div class="detail-title">📚 Kaynak</div>
                        <div class="detail-content" id="modalSource"></div>
                    </div>
                    <div class="detail-section">
                        <div class="detail-title">💭 Kişisel Notlarım</div>
                        <div class="detail-content" id="modalComment"></div>
                    </div>
                    <div class="detail-section">
                        <div class="detail-title">🖼️ Çözüm Görseli</div>
                        <div class="detail-content">
                            <img id="solutionImage" src="" alt="Çözüm Görseli">
                            <p id="noSolutionText" style="font-style: italic; color: #718096; display: none;">Çözüm görseli eklenmemiş.</p>
                            <input type="file" id="solutionInput" accept="image/*" style="margin-top: 10px;">
                            <button class="btn btn-primary" id="btnSaveSolution">Çözümü Kaydet</button>
                        </div>
                    </div>
                    <div class="detail-section">
                        <div class="detail-title">🔄 Durumu Güncelle</div>
                        <div class="status-changer">
                            <select id="modalDurumSelect">
                                <option value="cozulmedi">❌ Çözülmedi</option>
                                <option value="yarim">⚠️ Yarım Anladım</option>
                                <option value="cozuldu">✅ Çözüldü</option>
                            </select>
                            <button class="btn-status" id="btnUpdateStatus">Durumu Güncelle</button>
                        </div>
                    </div>
                    <div class="detail-section">
                        <button class="btn-delete" id="btnDeleteQuestion">❌ Soruyu Sil</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="fullscreenModal" class="modal">
        <span class="fullscreen-close" id="fullscreenCloseBtn">&times;</span>
        <img id="fullscreenModalContent">
    </div>

    <div id="subjectModal" class="modal" style="align-items: flex-start; padding-top: 5%;">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <span class="close" id="subjectModalCloseBtn">&times;</span>
                <h2 class="modal-title" id="subjectModalTitle">Konu Ekle</h2>
            </div>
            <div class="modal-body" style="grid-template-columns: 1fr; padding: 20px;">
                <p id="subjectModalInfo">Lütfen bu dersteki toplam <strong id="mistakeCount">0</strong> adet boş veya yanlış konunuzu girin.</p>
                <div class="form-group">
                    <label for="subjectInput">Konu Adı (Enter'a basarak ekleyin)</label>
                    <input type="text" id="subjectInput" placeholder="Örn: Trigonometri, Limit, Ses Bilgisi...">
                </div>
                <div id="subjectTagsContainer" class="modal-tags" style="margin-top: 15px; border: 1px solid var(--input-border); padding: 10px; border-radius: 10px; min-height: 50px;">
                    </div>
                <button id="saveSubjectsBtn" class="btn btn-primary" style="margin-top: 20px;">Konuları Kaydet</button>
            </div>
        </div>
    </div>

    <div id="testDetailModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <span class="close" id="testDetailModalCloseBtn">&times;</span>
                <h2 class="modal-title" id="testDetailModalTitle">Deneme Detayları</h2>
                <p class="modal-subtitle" id="testDetailModalDate"></p>
            </div>
            <div class="modal-body" id="testDetailModalBody" style="grid-template-columns: 1fr; padding: 25px; max-height: 70vh; overflow-y: auto;">
                </div>
        </div>
    </div>

    <script>
        // --- IndexedDB Setup ---
        let db;
        const DB_NAME = 'YKSDefteriDB';
        const DB_VERSION = 1;
        const QUESTION_STORE = 'questions';
        const TEST_STORE = 'tests';

        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);

                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains(QUESTION_STORE)) {
                        db.createObjectStore(QUESTION_STORE, { keyPath: 'id' });
                    }
                    if (!db.objectStoreNames.contains(TEST_STORE)) {
                        db.createObjectStore(TEST_STORE, { keyPath: 'id' });
                    }
                };

                request.onsuccess = (event) => {
                    db = event.target.result;
                    console.log('Database opened successfully');
                    resolve(db);
                };

                request.onerror = (event) => {
                    console.error('Database error:', event.target.errorCode);
                    reject(event.target.errorCode);
                };
            });
        }

        function getStore(storeName, mode) {
            const tx = db.transaction(storeName, mode);
            return tx.objectStore(storeName);
        }

        function addToDB(storeName, item) {
            return new Promise((resolve, reject) => {
                const store = getStore(storeName, 'readwrite');
                const request = store.add(item);
                request.onsuccess = () => resolve();
                request.onerror = (event) => reject(event.target.error);
            });
        }
        
        function updateInDB(storeName, item) {
             return new Promise((resolve, reject) => {
                const store = getStore(storeName, 'readwrite');
                const request = store.put(item);
                request.onsuccess = () => resolve();
                request.onerror = (event) => reject(event.target.error);
            });
        }

        function deleteFromDB(storeName, id) {
            return new Promise((resolve, reject) => {
                const store = getStore(storeName, 'readwrite');
                const request = store.delete(id);
                request.onsuccess = () => resolve();
                request.onerror = (event) => reject(event.target.error);
            });
        }

        function getAllFromDB(storeName) {
            return new Promise((resolve, reject) => {
                const store = getStore(storeName, 'readonly');
                const request = store.getAll();
                request.onsuccess = (event) => resolve(event.target.result);
                request.onerror = (event) => reject(event.target.error);
            });
        }

        // --- Application State ---
        let questions = [];
        let tests = [];
        let currentQuestionId = null;
        let tempMistakeSubjects = {}; // Deneme konularını geçici olarak tutmak için
        let bransChart, zorlukChart, tytTotalChart, aytTotalChart;
        let tytMatChart, tytTurkceChart, aytMatChart, aytFizikChart, aytKimyaChart, aytBiyolojiChart;

        async function loadData() {
            try {
                const [questionsData, testsData] = await Promise.all([
                    getAllFromDB(QUESTION_STORE),
                    getAllFromDB(TEST_STORE)
                ]);
                questions = questionsData;
                tests = testsData;
                updateUI();
                checkDailyStreak();
                updateWeeklyGoalStatus(); 
            } catch (error) {
                console.error("Failed to load data from DB:", error);
            }
        }

        function updateUI() {
            updateQuestionGrid();
            updateStats();
            updateFilterOptions();
            drawCharts();
            updateTestUI();
            updateRepeatQuestions();
        }
        
        async function saveQuestions() {
            const fileInput = document.getElementById('fileInput');
            const images = fileInput.files;

            if (images.length === 0) {
                alert('Lütfen bir görsel seçin.');
                return;
            }

            for (const image of images) {
                const reader = new FileReader();
                reader.onload = async function(e) {
                    const newQuestion = {
                        id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
                        image: e.target.result,
                        sinav: document.getElementById('sinavOturumu').value,
                        brans: document.getElementById('brans').value,
                        konu: document.getElementById('konu').value,
                        durum: document.getElementById('durum').value,
                        zorluk: document.getElementById('zorluk').value,
                        yorum: document.getElementById('yorum').value,
                        kaynak: document.getElementById('kaynak').value,
                        repeatDate: document.getElementById('repeatDate').value,
                        date: new Date().toISOString(),
                        solution: null
                    };

                    try {
                        await addToDB(QUESTION_STORE, newQuestion);
                        questions.push(newQuestion); 
                        
                        updateQuestionGrid();
                        updateStats();
                        updateFilterOptions();
                        drawCharts();
                        updateRepeatQuestions();
                        
                        document.getElementById('konu').value = '';
                        document.getElementById('yorum').value = '';
                        document.getElementById('kaynak').value = '';
                        document.getElementById('repeatDate').value = '';
                        fileInput.value = '';

                        checkDailyStreak(true);
                        updateWeeklyGoalStatus();
                    } catch (error) {
                        console.error("Failed to save question:", error);
                        alert("Soru kaydedilemedi. Depolama hatası.");
                    }
                };
                reader.readAsDataURL(image);
            }
        }

        async function saveTestResult() {
            const testType = document.getElementById('testType').value;
            const testName = document.getElementById('testName').value;

            if (!testName) {
                alert('Lütfen deneme adını girin.');
                return;
            }

            let testResult = {
                id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
                date: new Date().toISOString().split('T')[0],
                type: testType,
                name: testName,
                results: {}
            };

            const sections = {
                'TYT': ['tytMat', 'tytTurkce', 'tytSosyal', 'tytFen'],
                'AYT': ['aytMat', 'aytFizik', 'aytKimya', 'aytBiyoloji', 'aytEdebiyat', 'aytCografya']
            };

            let totalNet = 0;
            let formIsValid = true;
            sections[testType].forEach(section => {
                const total = parseInt(document.getElementById(`${section}Toplam`).value) || 0;
                const dogru = parseInt(document.querySelector(`.dogru-input[data-lesson='${section}']`).value) || 0;
                const yanlis = parseInt(document.querySelector(`.yanlis-input[data-lesson='${section}']`).value) || 0;
                
                if (dogru + yanlis > total) {
                    alert(`${section} dersi için doğru ve yanlış sayısı toplam soru sayısından fazla olamaz!`);
                    formIsValid = false;
                    return;
                }

                const bos = total - (dogru + yanlis);
                const net = dogru - (yanlis / 4);

                testResult.results[section] = { 
                    dogru, 
                    yanlis, 
                    bos,
                    net,
                    mistakeSubjects: tempMistakeSubjects[section] || []
                };
                totalNet += net;
            });

            if (!formIsValid) return;

            testResult.totalNet = totalNet;
            
            try {
                await addToDB(TEST_STORE, testResult);
                tests.push(testResult);
                updateTestUI();

                // Formu temizle
                document.getElementById('testName').value = '';
                sections[testType].forEach(section => {
                    document.querySelector(`.dogru-input[data-lesson='${section}']`).value = '';
                    document.querySelector(`.yanlis-input[data-lesson='${section}']`).value = '';
                    updateCounts(section); // Boş'ları da temizlemek için
                });
                tempMistakeSubjects = {};

            } catch (error) {
                console.error("Failed to save test result:", error);
                alert("Deneme sonucu kaydedilemedi.");
            }
        }

        async function updateQuestionStatus() {
            const newStatus = document.getElementById('modalDurumSelect').value;
            const questionIndex = questions.findIndex(q => q.id === currentQuestionId);
            if (questionIndex === -1) return;

            questions[questionIndex].durum = newStatus;
            
            try {
                await updateInDB(QUESTION_STORE, questions[questionIndex]);
                updateUI();
                closeModal();
            } catch (error) {
                console.error("Failed to update status:", error);
            }
        }
        
        async function saveSolutionImage() {
            const solutionInput = document.getElementById('solutionInput');
            const image = solutionInput.files[0];
            if (!image) {
                alert('Lütfen bir çözüm görseli seçin.');
                return;
            }

            const questionIndex = questions.findIndex(q => q.id === currentQuestionId);
            if (questionIndex === -1) return;

            const reader = new FileReader();
            reader.onload = async function(e) {
                questions[questionIndex].solution = e.target.result;
                try {
                    await updateInDB(QUESTION_STORE, questions[questionIndex]);
                    updateUI();
                    closeModal();
                } catch (error) {
                    console.error("Failed to save solution image:", error);
                }
            };
            reader.readAsDataURL(image);
        }

        async function deleteQuestion() {
            if (confirm('Bu soruyu silmek istediğinizden emin misiniz?')) {
                try {
                    await deleteFromDB(QUESTION_STORE, currentQuestionId);
                    questions = questions.filter(q => q.id !== currentQuestionId);
                    updateUI();
                    closeModal();
                } catch (error) {
                    console.error("Failed to delete question:", error);
                }
            }
        }
        
        async function deleteQuestionFromCard(id) {
            if (confirm('Bu soruyu kalıcı olarak silmek istediğinizden emin misiniz?')) {
                 try {
                    await deleteFromDB(QUESTION_STORE, id);
                    questions = questions.filter(q => q.id !== id);
                    updateUI();
                } catch (error) {
                    console.error("Failed to delete question from card:", error);
                }
            }
        }

        async function deleteTest(id) {
            if (!confirm('Bu deneme sonucunu kalıcı olarak silmek istediğinizden emin misiniz?')) {
                return; 
            }
            try {
                await deleteFromDB(TEST_STORE, id);
                tests = tests.filter(t => t.id !== id);
                updateTestUI(); 
            } catch (error) {
                console.error("Failed to delete test:", error);
                alert("Deneme silinirken bir hata oluştu.");
            }
        }

        async function exportData() {
            try {
                const questionsData = await getAllFromDB(QUESTION_STORE);
                const testsData = await getAllFromDB(TEST_STORE);

                if (questionsData.length === 0 && testsData.length === 0) {
                    alert('Dışa aktarılacak veri yok!');
                    return;
                }
                
                const dataToExport = { questions: questionsData, tests: testsData };
                const dataStr = JSON.stringify(dataToExport, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                
                const link = document.createElement('a');
                link.href = URL.createObjectURL(dataBlob);
                link.download = `yks-hata-defteri-${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                
                alert('Veriler başarıyla JSON dosyası olarak dışa aktarıldı.');
            } catch (error) {
                console.error("Export failed:", error);
                alert("Veriler dışa aktarılamadı.");
            }
        }

        function importData() {
            document.getElementById('importFile').click();
        }

        function handleImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    const importedQuestions = importedData.questions || [];
                    const importedTests = importedData.tests || [];
                    
                    if (confirm('Mevcut tüm verileriniz silinecek ve bu dosyadaki verilerle değiştirilecek. Emin misiniz?')) {
                        const tx = db.transaction([QUESTION_STORE, TEST_STORE], 'readwrite');
                        const questionStore = tx.objectStore(QUESTION_STORE);
                        const testStore = tx.objectStore(TEST_STORE);

                        questionStore.clear();
                        testStore.clear();

                        importedQuestions.forEach(q => questionStore.add(q));
                        importedTests.forEach(t => testStore.add(t));

                        tx.oncomplete = () => {
                            alert('Veriler başarıyla içe aktarıldı!');
                            loadData(); 
                        };
                        tx.onerror = (event) => {
                            console.error("Import transaction failed:", event.target.error);
                            alert("Veriler içe aktarılırken bir hata oluştu.");
                        };
                    }
                } catch (error) {
                    console.error("Import error:", error);
                    alert('Dosya formatı hatalı! Lütfen geçerli bir JSON dosyası seçin.');
                }
            };
            reader.readAsText(file);
        }
        
        function updateQuestionGrid(filteredQuestions = questions) {
            const grid = document.getElementById('questionGrid');
            grid.innerHTML = '';
            if (filteredQuestions.length === 0) {
                grid.innerHTML = `<div class="empty-state"><div class="empty-state-icon">📝</div><h3>${questions.length === 0 ? 'Henüz soru eklenmedi' : 'Filtrelemeye uyan soru bulunamadı'}</h3><p>${questions.length === 0 ? 'Yukarıdan soru görseli yükleyerek başlayın!' : 'Filtreleri değiştirerek yeniden deneyin.'}</p></div>`;
                return;
            }
            filteredQuestions.sort((a, b) => new Date(b.date) - new Date(a.date));
            filteredQuestions.forEach(q => {
                const card = document.createElement('div');
                card.className = 'question-card';
                card.dataset.questionId = q.id;
                let solutionIndicator = q.solution ? `<span class="question-solution-indicator">Çözüm Var</span>` : '';
                let repeatTag = '';
                if (q.repeatDate) {
                    const today = new Date().toISOString().split('T')[0];
                    if (q.repeatDate <= today) {
                        repeatTag = `<span class="tag tag-tekrar">Bugün Tekrar Et!</span>`;
                    }
                }
                card.innerHTML = `<button class="delete-btn" data-question-id="${q.id}">&times;</button><img src="${q.image}" alt="Soru görseli" class="question-image"><div class="question-info"><div class="question-tags"><span class="tag tag-sinav">${q.sinav}</span><span class="tag tag-brans">${q.brans}</span><span class="tag tag-zorluk ${q.zorluk}">${q.zorluk}</span><span class="tag tag-durum ${q.durum}">${q.durum === 'cozulmedi' ? 'Çözülmedi' : (q.durum === 'yarim' ? 'Yarım' : 'Çözüldü')}</span>${repeatTag}</div><p class="question-date">Eklenme Tarihi: ${new Date(q.date).toLocaleDateString()}</p>${solutionIndicator}<div class="question-comment">${q.yorum || 'Not yok.'}</div></div>`;
                grid.appendChild(card);
            });
        }
        function updateRepeatQuestions() {
            const repeatGrid = document.getElementById('repeatQuestionGrid');
            const today = new Date().toISOString().split('T')[0];
            const repeatQuestions = questions.filter(q => q.repeatDate && q.repeatDate <= today);
            repeatGrid.innerHTML = '';
            if (repeatQuestions.length === 0) {
                repeatGrid.innerHTML = `<div class="empty-state"><div class="empty-state-icon">🎉</div><h3>Bugün tekrar etmen gereken soru yok!</h3><p>Tekrar tarihi belirlediğin sorular burada görünecek.</p></div>`;
                return;
            }
            repeatQuestions.forEach(q => {
                const card = document.createElement('div');
                card.className = 'question-card';
                card.dataset.questionId = q.id;
                let solutionIndicator = q.solution ? `<span class="question-solution-indicator">Çözüm Var</span>` : '';
                card.innerHTML = `<button class="delete-btn" data-question-id="${q.id}">&times;</button><img src="${q.image}" alt="Soru görseli" class="question-image"><div class="question-info"><div class="question-tags"><span class="tag tag-sinav">${q.sinav}</span><span class="tag tag-brans">${q.brans}</span><span class="tag tag-zorluk ${q.zorluk}">${q.zorluk}</span><span class="tag tag-durum ${q.durum}">${q.durum === 'cozulmedi' ? 'Çözülmedi' : (q.durum === 'yarim' ? 'Yarım' : 'Çözüldü')}</span><span class="tag tag-tekrar">Bugün Tekrar Et!</span></div><p class="question-date">Eklenme Tarihi: ${new Date(q.date).toLocaleDateString()}</p>${solutionIndicator}<div class="question-comment">${q.yorum || 'Not yok.'}</div></div>`;
                repeatGrid.appendChild(card);
            });
        }
        function updateStats() {
            document.getElementById('totalQuestions').innerText = questions.length;
            document.getElementById('tytQuestions').innerText = questions.filter(q => q.sinav === 'TYT').length;
            document.getElementById('aytQuestions').innerText = questions.filter(q => q.sinav === 'AYT').length;
            document.getElementById('todayQuestions').innerText = questions.filter(q => q.date.split('T')[0] === new Date().toISOString().split('T')[0]).length;
            document.getElementById('solvedQuestions').innerText = questions.filter(q => q.durum === 'cozuldu').length;
            document.getElementById('hardQuestions').innerText = questions.filter(q => q.zorluk === 'zor').length;
        }
        function updateFilterOptions() {
            const filterBrans = document.getElementById('filterBrans');
            const currentFilter = filterBrans.value;
            filterBrans.innerHTML = '<option value="">Tümü</option>';
            const uniqueBrans = [...new Set(questions.map(q => q.brans))].sort();
            uniqueBrans.forEach(brans => {
                const option = document.createElement('option');
                option.value = brans;
                option.text = brans;
                filterBrans.appendChild(option);
            });
            filterBrans.value = currentFilter;
        }
        function applyFilters() {
            const filterSinav = document.getElementById('filterSinav').value;
            const filterBrans = document.getElementById('filterBrans').value;
            const filterDurum = document.getElementById('filterDurum').value;
            const filterZorluk = document.getElementById('filterZorluk').value;
            const filterSearchText = document.getElementById('filterSearchText').value.toLowerCase();
            const filtered = questions.filter(q => 
                (!filterSinav || q.sinav === filterSinav) &&
                (!filterBrans || q.brans === filterBrans) &&
                (!filterDurum || q.durum === filterDurum) &&
                (!filterZorluk || q.zorluk === filterZorluk) &&
                (!filterSearchText || q.konu.toLowerCase().includes(filterSearchText) || q.yorum.toLowerCase().includes(filterSearchText) || q.kaynak.toLowerCase().includes(filterSearchText))
            );
            updateQuestionGrid(filtered);
        }
        function clearFilters() {
            document.getElementById('filterSinav').value = '';
            document.getElementById('filterBrans').value = '';
            document.getElementById('filterDurum').value = '';
            document.getElementById('filterZorluk').value = '';
            document.getElementById('filterSearchText').value = '';
            applyFilters();
        }
        function openModal(id) {
            const question = questions.find(q => q.id === id);
            if (!question) return;
            currentQuestionId = id;
            document.getElementById('modalTitle').innerText = `${question.brans} - ${question.konu}`;
            document.getElementById('modalDate').innerText = `Eklenme Tarihi: ${new Date(question.date).toLocaleDateString()}`;
            document.getElementById('modalImage').src = question.image;
            document.getElementById('modalSource').innerText = question.kaynak || 'Belirtilmemiş';
            document.getElementById('modalComment').innerText = question.yorum || 'Not yok.';
            document.getElementById('modalDurumSelect').value = question.durum;
            const solutionImage = document.getElementById('solutionImage');
            const noSolutionText = document.getElementById('noSolutionText');
            if (question.solution) {
                solutionImage.src = question.solution;
                solutionImage.style.display = 'block';
                noSolutionText.style.display = 'none';
            } else {
                solutionImage.style.display = 'none';
                noSolutionText.style.display = 'block';
            }
            const modalTags = document.getElementById('modalTags');
            modalTags.innerHTML = `<span class="tag tag-sinav">${question.sinav}</span><span class="tag tag-brans">${question.brans}</span><span class="tag tag-zorluk ${question.zorluk}">${question.zorluk}</span><span class="tag tag-durum ${question.durum}">${question.durum === 'cozulmedi' ? 'Çözülmedi' : (question.durum === 'yarim' ? 'Yarım' : 'Çözüldü')}</span>`;
            if (question.repeatDate) {
                modalTags.innerHTML += `<span class="tag tag-tekrar">Tekrar Tarihi: ${question.repeatDate}</span>`;
            }
            document.getElementById('myModal').style.display = 'flex';
        }
        function closeModal() { document.getElementById('myModal').style.display = 'none'; }
        function openFullscreenModal(imageSrc) {
            document.getElementById('fullscreenModalContent').src = imageSrc;
            document.getElementById('fullscreenModal').style.display = 'flex';
        }
        function closeFullscreenModal() { document.getElementById('fullscreenModal').style.display = 'none'; }
        function toggleMenu() { document.getElementById('navMenu').classList.toggle('active'); }
        function showPage(pageId) {
            document.querySelectorAll('.tab-content').forEach(page => page.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            toggleMenu();
            if (pageId === 'questionPage') {
                updateQuestionGrid(); updateStats(); updateFilterOptions(); drawCharts(); updateRepeatQuestions();
            } else if (pageId === 'testPage') {
                updateTestUI();
            }
        }
        
        function updateTestUI() {
            const testListContainer = document.getElementById('testListContainer');
            testListContainer.innerHTML = '';
            if (tests.length === 0) {
                 testListContainer.innerHTML = `<div class="empty-state"><div class="empty-state-icon">📊</div><h3>Henüz deneme sonucu eklenmedi</h3><p>Yukarıdan deneme sonucunu ekleyerek başlayın!</p></div>`;
            } else {
                 tests.sort((a,b) => new Date(b.date) - new Date(a.date));
                 tests.forEach(test => {
                    const listItem = document.createElement('div');
                    listItem.className = 'test-list-item';
                    listItem.dataset.testid = test.id;
                    listItem.innerHTML = `
                        <button class="test-delete-btn" data-testid="${test.id}">&times;</button>
                        <div class="test-info">
                            <strong>${test.name}</strong> (${test.type})
                            <div class="date">${new Date(test.date).toLocaleDateString()}</div>
                        </div>
                        <div class="test-net">${test.totalNet.toFixed(2)} Net</div>
                    `;
                    testListContainer.appendChild(listItem);
                 });
            }
            drawTestCharts();
            updateTestStats();
        }

        function updateTestStats() {
            const tytTests = tests.filter(t => t.type === 'TYT');
            const aytTests = tests.filter(t => t.type === 'AYT');
            const tytNets = tytTests.map(t => t.totalNet);
            const aytNets = aytTests.map(t => t.totalNet);
            document.getElementById('tytAverageNet').innerText = tytNets.length > 0 ? (tytNets.reduce((a, b) => a + b, 0) / tytNets.length).toFixed(2) : 0;
            document.getElementById('tytBestNet').innerText = tytNets.length > 0 ? Math.max(...tytNets).toFixed(2) : 0;
            document.getElementById('aytAverageNet').innerText = aytNets.length > 0 ? (aytNets.reduce((a, b) => a + b, 0) / aytNets.length).toFixed(2) : 0;
            document.getElementById('aytBestNet').innerText = aytNets.length > 0 ? Math.max(...aytNets).toFixed(2) : 0;
        }
        function drawCharts() {
            const bransData = {}, zorlukData = {};
            questions.forEach(q => {
                bransData[q.brans] = (bransData[q.brans] || 0) + 1;
                zorlukData[q.zorluk] = (zorlukData[q.zorluk] || 0) + 1;
            });
            const commonOptions = { responsive: true, maintainAspectRatio: false };
            if (bransChart) bransChart.destroy();
            bransChart = new Chart(document.getElementById('bransChart').getContext('2d'), { type: 'pie', data: { labels: Object.keys(bransData), datasets: [{ data: Object.values(bransData), backgroundColor: ['#4299e1', '#48bb78', '#f6ad55', '#e53e3e', '#ecc94b', '#9f7aea', '#ed64a6'] }] }, options: commonOptions });
            if (zorlukChart) zorlukChart.destroy();
            zorlukChart = new Chart(document.getElementById('zorlukChart').getContext('2d'), { type: 'pie', data: { labels: Object.keys(zorlukData), datasets: [{ data: Object.values(zorlukData), backgroundColor: ['#48bb78', '#f6ad55', '#e53e3e'] }] }, options: commonOptions });
        }
        function drawTestCharts() {
            const chartConfigs = {
                tytTotalChart: { type: 'TYT', dataKey: 'totalNet', label: 'TYT Toplam Net', color: '#667eea' },
                aytTotalChart: { type: 'AYT', dataKey: 'totalNet', label: 'AYT Toplam Net', color: '#764ba2' },
                tytMatChart: { type: 'TYT', dataKey: 'results.tytMat.net', label: 'TYT Mat Net', color: '#4a5568' },
                tytTurkceChart: { type: 'TYT', dataKey: 'results.tytTurkce.net', label: 'TYT Türkçe Net', color: '#e53e3e' },
                aytMatChart: { type: 'AYT', dataKey: 'results.aytMat.net', label: 'AYT Mat Net', color: '#4a5568' },
                aytFizikChart: { type: 'AYT', dataKey: 'results.aytFizik.net', label: 'AYT Fizik Net', color: '#4299e1' },
                aytKimyaChart: { type: 'AYT', dataKey: 'results.aytKimya.net', label: 'AYT Kimya Net', color: '#f6ad55' },
                aytBiyolojiChart: { type: 'AYT', dataKey: 'results.aytBiyoloji.net', label: 'AYT Biyoloji Net', color: '#48bb78' },
            };
            const allCharts = { tytTotalChart, aytTotalChart, tytMatChart, tytTurkceChart, aytMatChart, aytFizikChart, aytKimyaChart, aytBiyolojiChart };

            for (const [chartId, config] of Object.entries(chartConfigs)) {
                const relevantTests = tests.filter(t => t.type === config.type).sort((a, b) => new Date(a.date) - new Date(b.date));
                const labels = relevantTests.map(t => t.name);
                const data = relevantTests.map(t => {
                    const keys = config.dataKey.split('.');
                    let value = t;
                    for (const key of keys) { value = value ? value[key] : undefined; }
                    return (value !== undefined ? value.toFixed(2) : 0);
                });

                if (allCharts[chartId]) allCharts[chartId].destroy();
                allCharts[chartId] = new Chart(document.getElementById(chartId).getContext('2d'), {
                    type: 'line',
                    data: { labels: labels, datasets: [{ label: config.label, data: data, borderColor: config.color, tension: 0.3 }] },
                    options: { responsive: true, maintainAspectRatio: false }
                });
            }
        }
        document.getElementById('testType').addEventListener('change', (e) => {
            const isTYT = e.target.value === 'TYT';
            document.getElementById('tytTestInputs').style.display = isTYT ? 'block' : 'none';
            document.getElementById('aytTestInputs').style.display = isTYT ? 'none' : 'block';
            document.getElementById('tytTotalQuestions').style.display = isTYT ? 'grid' : 'none';
            document.getElementById('aytTotalQuestions').style.display = isTYT ? 'none' : 'grid';
        });
        function loadTheme() {
            if (localStorage.getItem('darkMode') === 'true') {
                document.body.classList.add('dark-mode');
                document.getElementById('darkModeToggle').innerText = '🌙';
            }
        }
        function setWeeklyGoal() {
            const goal = parseInt(document.getElementById('weeklyGoalInput').value);
            if (isNaN(goal) || goal <= 0) { alert('Lütfen geçerli bir hedef girin.'); return; }
            localStorage.setItem('weeklyQuestionGoal', goal);
            alert(`Haftalık soru hedefiniz ${goal} olarak belirlendi!`);
            updateWeeklyGoalStatus();
        }
        function updateWeeklyGoalStatus() {
            const goal = parseInt(localStorage.getItem('weeklyQuestionGoal') || 0);
            const startOfWeek = new Date();
            startOfWeek.setDate(startOfWeek.getDate() - (startOfWeek.getDay() + 6) % 7);
            startOfWeek.setHours(0, 0, 0, 0);
            const weeklyQuestions = questions.filter(q => new Date(q.date) >= startOfWeek).length;
            const statusText = document.getElementById('weeklyGoalStatus');
            if (goal > 0) {
                statusText.innerHTML = `Hedef: ${goal} | Bu Hafta: ${weeklyQuestions} <br><progress value="${weeklyQuestions}" max="${goal}" style="width: 100%; margin-top: 5px;"></progress>`;
            } else {
                statusText.innerText = 'Henüz haftalık hedef belirlenmedi.';
            }
        }
        function checkDailyStreak(questionAdded = false) {
            const today = new Date().toISOString().split('T')[0];
            let streak = parseInt(localStorage.getItem('streak') || 0);
            const lastActiveDay = localStorage.getItem('lastActiveDay');
            if (questionAdded) {
                if (lastActiveDay !== today) {
                    const yesterday = new Date();
                    yesterday.setDate(yesterday.getDate() - 1);
                    streak = (lastActiveDay === yesterday.toISOString().split('T')[0]) ? streak + 1 : 1;
                    localStorage.setItem('lastActiveDay', today);
                    localStorage.setItem('streak', streak);
                }
            }
            document.getElementById('streakCounter').innerText = streak;
        }

        // YENİ FONKSİYONLAR
        function updateCounts(lesson) {
            const totalInput = document.getElementById(`${lesson}Toplam`);
            const dogruInput = document.querySelector(`.dogru-input[data-lesson='${lesson}']`);
            const yanlisInput = document.querySelector(`.yanlis-input[data-lesson='${lesson}']`);
            const bosDisplay = document.querySelector(`.bos-display[data-lesson='${lesson}']`);

            const total = parseInt(totalInput.value) || 0;
            const dogru = parseInt(dogruInput.value) || 0;
            const yanlis = parseInt(yanlisInput.value) || 0;

            if (dogru + yanlis > total) {
                yanlisInput.style.borderColor = 'red';
            } else {
                yanlisInput.style.borderColor = ''; // Stili sıfırla
            }
            
            const bos = Math.max(0, total - (dogru + yanlis));
            bosDisplay.value = bos;
        }

        let currentLessonForSubjects = null; 

        function openSubjectModal(lesson) {
            currentLessonForSubjects = lesson;
            const lessonLabel = document.querySelector(`.test-input-grid label[for='${lesson}Dogru']`)?.innerText || lesson;
            
            const yanlis = parseInt(document.querySelector(`.yanlis-input[data-lesson='${lesson}']`).value) || 0;
            const bos = parseInt(document.querySelector(`.bos-display[data-lesson='${lesson}']`).value) || 0;
            const totalMistakes = yanlis + bos;

            if (totalMistakes === 0) {
                alert("Bu derste boş veya yanlışınız bulunmuyor. Konu ekleyemezsiniz.");
                return;
            }

            document.getElementById('subjectModalTitle').innerText = `${lessonLabel} - Hatalı Konular`;
            document.getElementById('mistakeCount').innerText = totalMistakes;
            
            updateSubjectTags();
            
            document.getElementById('subjectModal').style.display = 'flex';
            document.getElementById('subjectInput').focus();
        }

        function closeSubjectModal() {
            document.getElementById('subjectModal').style.display = 'none';
        }

        function updateSubjectTags() {
            const container = document.getElementById('subjectTagsContainer');
            container.innerHTML = '';
            const subjects = tempMistakeSubjects[currentLessonForSubjects] || [];
            subjects.forEach(subject => {
                const tag = document.createElement('span');
                tag.className = 'tag';
                tag.innerText = subject;
                tag.onclick = () => removeSubject(subject);
                container.appendChild(tag);
            });
        }

        function addSubject(subject) {
            if (!subject.trim()) return;
            if (!tempMistakeSubjects[currentLessonForSubjects]) {
                tempMistakeSubjects[currentLessonForSubjects] = [];
            }
            const subjects = tempMistakeSubjects[currentLessonForSubjects];
            const yanlis = parseInt(document.querySelector(`.yanlis-input[data-lesson='${currentLessonForSubjects}']`).value) || 0;
            const bos = parseInt(document.querySelector(`.bos-display[data-lesson='${currentLessonForSubjects}']`).value) || 0;
            const totalMistakes = yanlis + bos;

            if (subjects.length >= totalMistakes) {
                alert(`Maksimum ${totalMistakes} konu ekleyebilirsiniz.`);
                return;
            }
            if (!subjects.includes(subject.trim())) {
                subjects.push(subject.trim());
            }
            updateSubjectTags();
        }

        function removeSubject(subject) {
            const subjects = tempMistakeSubjects[currentLessonForSubjects] || [];
            const index = subjects.indexOf(subject);
            if (index > -1) subjects.splice(index, 1);
            updateSubjectTags();
        }

        function openTestDetailModal(testId) {
            const test = tests.find(t => t.id === testId);
            if (!test) return;
            document.getElementById('testDetailModalTitle').innerText = test.name;
            document.getElementById('testDetailModalDate').innerText = `Tarih: ${new Date(test.date).toLocaleDateString()}`;
            const body = document.getElementById('testDetailModalBody');
            body.innerHTML = '';
            for (const lesson in test.results) {
                const data = test.results[lesson];
                const lessonName = (document.querySelector(`label[for='${lesson}Dogru']`)?.innerText || lesson.replace('tyt', 'TYT ').replace('ayt', 'AYT '));
                let subjectsHTML = '<p><em>Hatalı konu eklenmemiş.</em></p>';
                if (data.mistakeSubjects && data.mistakeSubjects.length > 0) {
                    subjectsHTML = data.mistakeSubjects.map(s => `<span class="tag tag-konu">${s}</span>`).join('');
                }
                const detailHTML = `<div class="detail-section"><div class="detail-title">${lessonName}</div><div class="detail-content" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; text-align: center;"><div><strong>Doğru:</strong> ${data.dogru}</div><div><strong>Yanlış:</strong> ${data.yanlis}</div><div><strong>Boş:</strong> ${data.bos}</div><div><strong>Net:</strong> ${data.net.toFixed(2)}</div></div><h4 style="margin-top: 15px; margin-bottom: 10px; color: var(--section-title-color);">Boş/Yanlış Konuları</h4><div class="modal-tags">${subjectsHTML}</div></div><hr style="border-top: 1px dashed var(--section-border-color); margin: 20px 0;">`;
                body.innerHTML += detailHTML;
            }
            document.getElementById('testDetailModal').style.display = 'flex';
        }

        function closeTestDetailModal() {
            document.getElementById('testDetailModal').style.display = 'none';
        }

        // --- Add Event Listeners ---
        function addEventListeners() {
            document.getElementById('hamburgerMenu').addEventListener('click', toggleMenu);
            document.getElementById('darkModeToggle').addEventListener('click', () => {
                document.body.classList.toggle('dark-mode');
                const isDarkMode = document.body.classList.contains('dark-mode');
                localStorage.setItem('darkMode', isDarkMode);
                document.getElementById('darkModeToggle').innerText = isDarkMode ? '🌙' : '☀️';
                drawCharts(); drawTestCharts();
            });
            document.querySelectorAll('.nav-menu a').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    showPage(link.dataset.page);
                });
            });

            document.getElementById('uploadArea').addEventListener('click', () => document.getElementById('fileInput').click());
            document.getElementById('btnSaveQuestions').addEventListener('click', saveQuestions);

            document.getElementById('btnClearFilters').addEventListener('click', clearFilters);
            document.getElementById('btnExport').addEventListener('click', exportData);
            document.getElementById('btnImport').addEventListener('click', importData);
            document.getElementById('importFile').addEventListener('change', handleImport);
            
            const filterInputs = ['filterSearchText', 'filterSinav', 'filterBrans', 'filterDurum', 'filterZorluk'];
            filterInputs.forEach(id => document.getElementById(id).addEventListener('input', applyFilters));

            document.getElementById('btnSetGoal').addEventListener('click', setWeeklyGoal);
            document.getElementById('btnSaveTestResult').addEventListener('click', saveTestResult);

            document.getElementById('modalCloseBtn').addEventListener('click', closeModal);
            document.getElementById('btnSaveSolution').addEventListener('click', saveSolutionImage);
            document.getElementById('btnUpdateStatus').addEventListener('click', updateQuestionStatus);
            document.getElementById('btnDeleteQuestion').addEventListener('click', deleteQuestion);
            
            document.getElementById('fullscreenCloseBtn').addEventListener('click', closeFullscreenModal);
            document.getElementById('modalImage').addEventListener('click', () => openFullscreenModal(document.getElementById('modalImage').src));
            document.getElementById('solutionImage').addEventListener('click', () => {
                const imgSrc = document.getElementById('solutionImage').src;
                if (imgSrc) openFullscreenModal(imgSrc);
            });

            document.getElementById('questionGrid').addEventListener('click', (e) => {
                const card = e.target.closest('.question-card');
                if (!card) return;
                if (e.target.classList.contains('delete-btn')) {
                    e.stopPropagation();
                    deleteQuestionFromCard(e.target.dataset.questionId);
                } else {
                    openModal(card.dataset.questionId);
                }
            });
            document.getElementById('repeatQuestionGrid').addEventListener('click', (e) => {
                const card = e.target.closest('.question-card');
                if (!card) return;
                if (e.target.classList.contains('delete-btn')) {
                    e.stopPropagation();
                    deleteQuestionFromCard(e.target.dataset.questionId);
                } else {
                    openModal(card.dataset.questionId);
                }
            });
            
            // YENİ Event Listeners
            document.querySelectorAll('.count-input, .total-q-input').forEach(input => {
                input.addEventListener('input', () => updateCounts(input.dataset.lesson));
            });
            document.getElementById('testPage').addEventListener('click', (e) => {
                if (e.target.classList.contains('btn-add-subject')) {
                    openSubjectModal(e.target.dataset.lesson);
                }
            });
            document.getElementById('subjectModalCloseBtn').addEventListener('click', closeSubjectModal);
            document.getElementById('saveSubjectsBtn').addEventListener('click', closeSubjectModal);
            document.getElementById('subjectInput').addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    addSubject(e.target.value);
                    e.target.value = '';
                }
            });
            document.getElementById('testDetailModalCloseBtn').addEventListener('click', closeTestDetailModal);

            document.getElementById('testListContainer').addEventListener('click', (e) => {
                const deleteBtn = e.target.closest('.test-delete-btn');
                if (deleteBtn) {
                    deleteTest(deleteBtn.dataset.testid);
                    return;
                }
                const testItem = e.target.closest('.test-list-item');
                if (testItem) {
                    openTestDetailModal(testItem.dataset.testid);
                }
            });
        }

        window.addEventListener('load', async function() {
            try {
                await initDB();
                addEventListeners();
                loadTheme();
                await loadData();
            } catch (error) {
                console.error("Initialization failed:", error);
                alert("Uygulama başlatılamadı. Veritabanı hatası.");
            }
        });

    </script>
</body>
</html>
